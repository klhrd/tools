<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>縮網址 API 實測工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">縮網址 API 整合測試器</h1>
            <p class="text-gray-600 font-medium text-sm md:text-base">解決 GitHub Pages 安全連線與 URL 錨點 (#) 問題</p>
        </header>

        <!-- Input Section -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="url" id="urlInput" placeholder="輸入長網址，包含 # 也可以測試" 
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="testAllApis()" id="btnTest" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    同時測試所有 API
                </button>
            </div>
            <p class="mt-3 text-xs text-gray-400 italic text-center md:text-left">
                提示：我們會使用 encodeURIComponent() 處理網址，解決 # 符號被截斷的問題。
            </p>
        </div>

        <!-- Results Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            <!-- Is.gd -->
            <div class="bg-white p-5 rounded-xl shadow border-t-4 border-green-500">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg">Is.gd</h3>
                    <span id="res-isgd" class="text-xs text-gray-400 font-bold">待測試</span>
                </div>
                <div id="link-isgd" class="mt-3 font-mono text-blue-600 break-all p-2 bg-gray-50 rounded min-h-[40px]"></div>
            </div>

            <!-- TinyURL -->
            <div class="bg-white p-5 rounded-xl shadow border-t-4 border-blue-400">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-lg">TinyURL</h3>
                    <span id="res-tinyurl" class="text-xs text-gray-400 font-bold">待測試</span>
                </div>
                <div id="link-tinyurl" class="mt-3 font-mono text-blue-600 break-all p-2 bg-gray-50 rounded min-h-[40px]"></div>
            </div>
        </div>

        <!-- Knowledge Section -->
        <div class="bg-blue-50 rounded-xl p-6 border border-blue-100 mb-8">
            <h2 class="text-lg font-bold text-blue-800 mb-3">為何 GitHub Pages 容易失敗？</h2>
            <ul class="text-blue-700 text-sm list-disc ml-5 space-y-2">
                <li><strong>HTTPS 限制：</strong>GitHub Pages 必須使用 HTTPS，如果代理伺服器（Proxy）或 API 的憑證不全，瀏覽器會直接攔截請求。</li>
                <li><strong>網址長度上限：</strong>如果你傳輸的加密網址（# 之後的內容）太長，超出了 Proxy 或 GitHub 的傳輸限制（約 2000-4000 字元），請求會被切斷。</li>
                <li><strong>雙重編碼：</strong>在代理模式下，網址需要經過兩次編碼，否則特殊符號會導致代理解析失敗。</li>
            </ul>
        </div>
    </div>

    <script>
        // 在 GitHub Pages 上，AllOrigins 較為穩定，我們使用他的 /get 介面來處理
        const PROXY_BASE = "https://api.allorigins.win/get?url=";

        async function testAllApis() {
            const longUrl = document.getElementById('urlInput').value.trim();
            if (!longUrl) {
                alert("請輸入網址");
                return;
            }

            const encodedUrl = encodeURIComponent(longUrl);

            // 1. 測試 Is.gd
            const statusIsgd = document.getElementById(`res-isgd`);
            const linkIsgd = document.getElementById(`link-isgd`);
            statusIsgd.innerText = "請求中...";
            statusIsgd.className = "text-xs text-blue-500 font-bold";
            linkIsgd.innerText = "";
            
            const isgdApi = `https://is.gd/create.php?format=json&url=${encodedUrl}`;
            
            fetch(`${PROXY_BASE}${encodeURIComponent(isgdApi)}`)
                .then(r => {
                    if(!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(proxyData => {
                    // AllOrigins 的內容在 contents 欄位，且是字串格式
                    const data = JSON.parse(proxyData.contents);
                    if(data.shorturl) {
                        statusIsgd.innerText = "成功";
                        statusIsgd.className = "text-xs text-green-600 font-bold";
                        linkIsgd.innerHTML = `<a href="${data.shorturl}" target="_blank" class="underline hover:text-blue-800">${data.shorturl}</a>`;
                    } else {
                        throw new Error(data.errormessage || "API 錯誤");
                    }
                })
                .catch(e => {
                    statusIsgd.innerText = "失敗";
                    statusIsgd.className = "text-xs text-red-500 font-bold";
                    linkIsgd.innerText = "錯誤原因: " + e.message;
                });

            // 2. 測試 TinyURL
            const statusTiny = document.getElementById(`res-tinyurl`);
            const linkTiny = document.getElementById(`link-tinyurl`);
            statusTiny.innerText = "請求中...";
            statusTiny.className = "text-xs text-blue-500 font-bold";
            linkTiny.innerText = "";

            const tinyApi = `https://tinyurl.com/api-create.php?url=${encodedUrl}`;
            fetch(`${PROXY_BASE}${encodeURIComponent(tinyApi)}`)
                .then(r => {
                    if(!r.ok) throw new Error(`HTTP ${r.status}`);
                    return r.json();
                })
                .then(proxyData => {
                    const text = proxyData.contents;
                    if(text.startsWith('http')) {
                        statusTiny.innerText = "成功";
                        statusTiny.className = "text-xs text-green-600 font-bold";
                        linkTiny.innerHTML = `<a href="${text}" target="_blank" class="underline hover:text-blue-800">${text}</a>`;
                    } else {
                        throw new Error("API 傳回無效數據");
                    }
                })
                .catch(e => {
                    statusTiny.innerText = "失敗";
                    statusTiny.className = "text-xs text-red-500 font-bold";
                    linkTiny.innerText = "連線失敗，請檢查網路";
                });
        }
    </script>
</body>
</html>