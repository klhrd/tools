<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç›£è€ƒè€…ç­–ç•¥æ¨¡æ“¬å™¨ v2.1.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .panel { @apply bg-white shadow-sm rounded-xl p-6 border border-slate-200; }
        .btn { @apply px-4 py-2 rounded-lg font-semibold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed; }
        .btn-primary { @apply bg-sky-600 text-white hover:bg-sky-700 active:scale-95; }
        .btn-success { @apply bg-emerald-500 text-white hover:bg-emerald-600 active:scale-95; }
        .btn-warning { @apply bg-amber-500 text-white hover:bg-amber-600 active:scale-95; }
        .btn-danger { @apply bg-rose-500 text-white hover:bg-rose-600 active:scale-95; }
        .btn-ai { @apply bg-indigo-600 text-white hover:bg-indigo-700 active:scale-95 shadow-sm hover:shadow-indigo-200/50; }
        .btn-auto { @apply bg-gradient-to-r from-violet-600 to-indigo-600 text-white hover:from-violet-700 hover:to-indigo-700 active:scale-95 shadow-md; }
        .input-field { @apply w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition; }
        .stat-card { @apply bg-slate-50 p-4 rounded-lg text-center border border-slate-200; }
        .log-entry { @apply py-2 border-b border-slate-100 text-sm; }
        #log-area::-webkit-scrollbar { width: 8px; }
        #log-area::-webkit-scrollbar-track { background: #f1f5f9; }
        #log-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        #log-area::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="p-6 flex flex-col md:flex-row justify-center gap-6 max-w-7xl mx-auto">

    <!-- å·¦å´ï¼šè¨­å®šèˆ‡ AI é¢æ¿ -->
    <div class="flex flex-col gap-6 w-full md:w-1/3 min-w-[320px]">
        <div class="panel">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                ğŸ› ï¸ è€ƒè©¦åƒæ•¸è¨­å®š
            </h2>
            <div class="space-y-3">
                <div>
                    <label class="text-sm font-medium text-slate-600">ç¸½è€ƒç”Ÿäººæ•¸ (N)</label>
                    <input type="number" id="student-count" value="1000" class="input-field">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-sm font-medium text-slate-600">å¹³å‡æ™‚é–“ (Î¼)</label>
                        <input type="number" id="mean-time" value="90" class="input-field">
                    </div>
                    <div>
                        <label class="text-sm font-medium text-slate-600">æ¨™æº–å·® (Ïƒ)</label>
                        <input type="number" id="std-dev" value="15" class="input-field">
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-600">åŸºç¤è€ƒè©¦æ™‚é–“ (T_base)</label>
                    <input type="number" id="base-time" value="100" class="input-field">
                </div>
                <button id="start-exam" class="btn btn-primary w-full mt-2">é–‹å§‹è€ƒè©¦</button>
            </div>
        </div>

        <div class="panel border-indigo-100 bg-indigo-50/50">
            <h2 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                ğŸ¤– AI ç›£è€ƒå®˜
            </h2>
            
            <button id="auto-pilot-btn" class="btn btn-auto w-full mb-4 flex items-center justify-center gap-2" disabled>
                <span>ğŸš€ å•Ÿå‹•è‡ªå‹•ç›£è€ƒ (Auto-Pilot)</span>
            </button>

            <hr class="border-indigo-200 my-4">

            <p class="text-sm text-indigo-700 mb-4">
                æ‰‹å‹•æ¨¡å¼ï¼šè«‹å…ˆã€Œè©¢å•èˆ‰æ‰‹ã€ç²å–æ•¸æ“šï¼Œå†è«‹æ±‚å»ºè­°ã€‚
            </p>
            <div id="ai-suggestion-box" class="hidden bg-white p-4 rounded-lg border border-indigo-100 shadow-sm mb-4">
                <h3 class="font-bold text-indigo-800 mb-2">ğŸ’¡ åˆ†æå ±å‘Š</h3>
                <p id="ai-analysis-text" class="text-sm text-slate-600 leading-relaxed mb-3"></p>
                <button id="apply-ai-suggestion" class="btn btn-ai w-full text-sm">
                    æ¡ç´å»ºè­°ï¼šå»¶é•· <span id="ai-suggest-minutes">0</span> åˆ†é˜
                </button>
            </div>
            <button id="ask-ai-btn" class="btn btn-ai w-full" disabled>
                è«‹æ±‚ AI åˆ†æèˆ‡å»ºè­°
            </button>
        </div>
    </div>

    <!-- å³å´ï¼šæ¨¡æ“¬æ“ä½œèˆ‡çµæœ -->
    <div class="flex flex-col gap-6 w-full md:w-2/3">
        <div class="panel">
            <h2 class="text-xl font-bold text-slate-800 mb-4">ğŸ® ç›£è€ƒæ“ä½œå°</h2>
            
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="stat-card">
                    <div class="text-slate-500 text-sm mb-1">ç›®å‰æ™‚é–“</div>
                    <div id="current-time-display" class="text-3xl font-bold text-sky-600">--</div>
                    <div class="text-xs text-slate-400">åˆ†é˜</div>
                </div>
                <div class="stat-card">
                    <div class="text-slate-500 text-sm mb-1">æœªå®Œæˆäººæ•¸</div>
                    <div id="unfinished-display" class="text-3xl font-bold text-rose-500">--</div>
                    <div class="text-xs text-slate-400">äºº (ä¸Šæ¬¡è©¢å•)</div>
                </div>
                <div class="stat-card">
                    <div class="text-slate-500 text-sm mb-1">è©¢å•æ¬¡æ•¸</div>
                    <div id="inquiry-count-display" class="text-3xl font-bold text-amber-500">0</div>
                    <div class="text-xs text-slate-400">æ¬¡</div>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 mb-6 p-4 bg-slate-50 rounded-lg border border-slate-100">
                <button id="inquire-btn" class="btn btn-warning flex-1 min-w-[120px]" disabled>
                    ğŸ™‹â€â™‚ï¸ è©¢å•èˆ‰æ‰‹
                </button>
                <div class="flex flex-1 min-w-[180px] gap-2">
                    <input type="number" id="extend-minutes" value="10" class="input-field w-20 text-center" placeholder="åˆ†">
                    <button id="extend-btn" class="btn btn-success flex-1" disabled>
                        â±ï¸ å»¶é•·æ™‚é–“
                    </button>
                </div>
                <button id="end-exam-btn" class="btn btn-danger flex-1 min-w-[120px]" disabled>
                    ğŸ›‘ ç«‹å³æ”¶å·
                </button>
            </div>

            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-slate-700 flex items-center gap-2">
                    <span>ğŸ“‹ äº‹ä»¶æ—¥èªŒ</span>
                    <span id="auto-status" class="text-sm font-normal text-indigo-600 hidden bg-indigo-50 px-2 py-1 rounded-full animate-pulse">
                        ğŸ¤– è‡ªå‹•ç›£è€ƒä¸­...
                    </span>
                </h3>
                <button id="copy-log-btn" class="text-xs text-slate-500 hover:text-slate-700 bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                    </svg>
                    è¤‡è£½æ—¥èªŒ
                </button>
            </div>
            <div id="log-area" class="h-80 overflow-y-auto bg-slate-50 p-4 rounded-lg border border-slate-200 font-mono text-sm leading-relaxed">
                <div class="text-slate-500 italic">è«‹è¨­å®šåƒæ•¸ä¸¦é»æ“Šã€Œé–‹å§‹è€ƒè©¦ã€ã€‚</div>
            </div>
        </div>
    </div>

    <script>
        const $ = (id) => document.getElementById(id);
        const gaussian = (mu, sigma) => {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v) * sigma + mu;
        };

        let state = {
            running: false, autoPilot: false,
            N: 1000, mu: 90, sigma: 15, t_base: 100,
            students: [], currentTime: 0, inquiries: 0,
            lastInquiryTime: -1, lastInquiryCount: -1,
            sameInquiryCountTimes: 0
        };

        function log(msg, type = 'info') {
            const colors = {
                info: 'text-slate-600', start: 'text-sky-600 font-bold',
                inquiry: 'text-amber-600', extend: 'text-emerald-600',
                ai: 'text-indigo-600', end: 'text-rose-600 font-bold',
                stats: 'bg-amber-50 p-3 rounded-lg text-amber-900 my-2 border border-amber-100 shadow-sm'
            };
            const entry = document.createElement('div');
            entry.className = `log-entry ${colors[type] || colors.info}`;
            entry.innerHTML = msg;
            $('log-area').appendChild(entry);
            $('log-area').scrollTop = $('log-area').scrollHeight;
        }

        function updateDisplay() {
            $('current-time-display').textContent = state.currentTime.toFixed(0);
            $('inquiry-count-display').textContent = state.inquiries;
            $('unfinished-display').textContent = state.lastInquiryCount !== -1 ? state.lastInquiryCount : '--';
        }

        function setControlsEnabled(enabled) {
            ['inquire-btn', 'extend-btn', 'end-exam-btn', 'ask-ai-btn', 'auto-pilot-btn'].forEach(id => $(id).disabled = !enabled);
            ['start-exam', 'student-count', 'mean-time', 'std-dev', 'base-time'].forEach(id => $(id).disabled = enabled);
        }

        // --- æ ¸å¿ƒæ“ä½œ ---
        $('start-exam').onclick = () => {
            state.N = +$('student-count').value;
            state.mu = +$('mean-time').value;
            state.sigma = +$('std-dev').value;
            state.t_base = +$('base-time').value;
            state.students = Array.from({length: state.N}, () => Math.max(1, Math.ceil(gaussian(state.mu, state.sigma))));
            const realAllFinishedTime = Math.max(...state.students);
            state.currentTime = state.t_base;
            state.inquiries = 0;
            state.lastInquiryTime = -1;
            state.lastInquiryCount = -1;
            state.sameInquiryCountTimes = 0;
            state.running = true;
            state.autoPilot = false;

            $('log-area').innerHTML = '';
            $('ai-suggestion-box').classList.add('hidden');
            $('auto-status').classList.add('hidden');
            log(`ğŸš€ è€ƒè©¦é–‹å§‹ï¼N=${state.N}, Î¼=${state.mu}, Ïƒ=${state.sigma}, åŸºç¤æ™‚é–“=${state.t_base}åˆ†`, 'start');
            updateDisplay();
            setControlsEnabled(true);
        };

        $('inquire-btn').onclick = () => {
            const currentUnfinished = state.students.filter(t => t > state.currentTime).length;
            
            if (currentUnfinished === state.lastInquiryCount && currentUnfinished > 0) {
                state.sameInquiryCountTimes++;
            } else {
                state.sameInquiryCountTimes = 0;
            }

            state.inquiries++;
            state.lastInquiryTime = state.currentTime;
            state.lastInquiryCount = currentUnfinished;

            log(`ğŸ™‹ [${state.currentTime}åˆ†] è©¢å•ï¼š<strong>${state.lastInquiryCount}</strong> äººæœªå®Œæˆã€‚`, 'inquiry');
            updateDisplay();
            return state.lastInquiryCount;
        };

        $('extend-btn').onclick = () => {
            const mins = +$('extend-minutes').value;
            if (mins <= 0) return;
            state.currentTime += mins;
            log(`â±ï¸ å»¶é•· ${mins} åˆ†é˜ -> ç›®å‰æ™‚é–“: ${state.currentTime} åˆ†`, 'extend');
            updateDisplay();
        };

        $('end-exam-btn').onclick = () => {
            state.running = false;
            state.autoPilot = false;
            $('auto-status').classList.add('hidden');
            const finalUnfinished = state.students.filter(t => t > state.currentTime).length;
            const realAllFinishedTime = Math.max(...state.students);
            const wasted = Math.max(0, state.currentTime - realAllFinishedTime);

            log(`ğŸ›‘ æ”¶å·ï¼æœ€çµ‚æ™‚é–“: ${state.currentTime} åˆ†`, 'end');
            log(`ğŸ“Š <strong>æœ€çµ‚å ±å‘Šï¼š</strong><br>
                 - ç¸½è©¢å•æ¬¡æ•¸: ${state.inquiries} æ¬¡<br>
                 - å…¨é«”ç­‰å¾…æ™‚é–“: ${wasted.toFixed(0)} åˆ†é˜<br>
                 - æœªå®Œæˆäººæ•¸: ${finalUnfinished} äºº (${(finalUnfinished/state.N*100).toFixed(2)}%)`, 'stats');
            setControlsEnabled(false);
        };

        // --- AI åˆ†æå‡½æ•¸ (v2.1.2 å„ªåŒ–ç‰ˆï¼šé«˜ Sigma ç©©å®šç­–ç•¥) ---
        function getAIAnalysis() {
            const t = state.lastInquiryTime;
            const n_unf = state.lastInquiryCount;
            const p_unf = Math.max(n_unf / state.N, 1e-9);
            const p_fin = 1 - p_unf;
            const current_z = jStat.normal.inv(p_fin, 0, 1);
            const est_mu = t - (state.sigma * current_z);

            let target_z = 3.09; // 99.9%
            if (p_unf < 0.001) target_z = 3.71; // 99.99%
            if (p_unf < 0.0001) target_z = 4.26; // 99.999%

            let suggested_end = Math.ceil(est_mu + state.sigma * target_z);
            let suggest_extend = Math.max(0, suggested_end - state.currentTime);

            // --- éšæ®µæ€§å»¶é•·ç­–ç•¥ v2.1.2 ---

            // 1. é«˜ Sigma ç©©å®šç­–ç•¥ (äººæ•¸è¼ƒå¤šæ™‚ï¼Œå¼·åˆ¶æœ€å°é€²åº¦)
            // é©ç”¨æ–¼ n_unf > 5 çš„æƒ…æ³ (é¿å…é™·å…¥ 1-2 åˆ†é˜å¾ªç’°ï¼Œç‰¹åˆ¥æ˜¯ç•¶ Sigma å¾ˆå¤§æ™‚)
            if (n_unf > 5) {
                const MIN_PROGRESS_PERCENTAGE = 0.01; // 1% of sigma as a minimum step
                const MIN_PROGRESS_MINUTES = Math.min(Math.ceil(state.sigma * MIN_PROGRESS_PERCENTAGE), 20); // ä¸Šé™ 20 åˆ†é˜
                
                // å¦‚æœ Z-score è¨ˆç®—çµæœå°æ–¼é€™å€‹æœ€å°é€²åº¦ï¼Œå‰‡å¼·åˆ¶ä½¿ç”¨æœ€å°é€²åº¦
                if (suggest_extend <= 2) { // åƒ…åœ¨è¨ˆç®—çµæœæ¥µå°æ™‚æ‰ä»‹å…¥
                    suggest_extend = Math.max(suggest_extend, MIN_PROGRESS_MINUTES);
                }
            }


            // 2. æ¥µç«¯å°¾éƒ¨ç­–ç•¥ (n_unf <= 5): æ¡ç”¨æ¼¸é€²å¼ç·©è¡
            // è™•ç†æ¥µå°‘æ•¸äººæ™‚ï¼Œé¿å…ä¸€æ¬¡å»¶é•·å¤ªå¤šï¼Œä½†ä»è¦å¼·åˆ¶é€²åº¦ã€‚
            if (n_unf <= 5 && n_unf > 0) {
                 // æ ¹æ“šé€£çºŒè©¢å•æ¬¡æ•¸ï¼Œå‹•æ…‹æ±ºå®šç·©è¡ä¿‚æ•¸ (0.1 -> 0.2 -> 0.3 -> 0.5)
                 let buffer_multiplier = 0.1;
                 if (state.sameInquiryCountTimes === 1) buffer_multiplier = 0.2;
                 else if (state.sameInquiryCountTimes === 2) buffer_multiplier = 0.3;
                 else if (state.sameInquiryCountTimes >= 3) buffer_multiplier = 0.5;

                 // æ¼¸é€²ç·©è¡ï¼šåŸºæ–¼ Sigma çš„ç™¾åˆ†æ¯”
                 let buffered_extension = Math.ceil(state.sigma * buffer_multiplier);
                 
                 // æ¡ç”¨ calculated, buffered, æˆ–æœ€å°å€¼ 5 åˆ†é˜ä¸­çš„æœ€å¤§å€¼
                 // ç¢ºä¿è‡³å°‘å»¶é•· 5 åˆ†é˜ï¼Œä¸¦å°‡ç·©è¡ä¸Šé™è¨­ç‚º 30 åˆ†é˜
                 suggest_extend = Math.max(suggest_extend, Math.min(buffered_extension, 30), 5);
            }

            if (suggest_extend === 0 && n_unf > 0) suggest_extend = 1;

            return { est_mu, suggest_extend, n_unf, p_unf, target_z };
        }

        $('ask-ai-btn').onclick = () => {
            if (state.lastInquiryTime === -1) return alert("è«‹å…ˆè©¢å•ä¸€æ¬¡ï¼");
            const analysis = getAIAnalysis();
            $('ai-analysis-text').innerHTML = `
                åœ¨ ${state.lastInquiryTime} åˆ†æ™‚æœ‰ ${analysis.n_unf} äººæœªå®Œæˆã€‚<br>
                æ¨ä¼° Î¼ â‰ˆ <strong>${analysis.est_mu.toFixed(1)}</strong>ã€‚<br>
                å»ºè­°å»¶é•·ï¼š
            `;
            $('ai-suggest-minutes').textContent = analysis.suggest_extend;
            $('ai-suggestion-box').classList.remove('hidden');
            log(`ğŸ¤– AI å»ºè­°å»¶é•· ${analysis.suggest_extend} åˆ†é˜ã€‚`, 'ai');
        };

        $('apply-ai-suggestion').onclick = () => {
             const mins = +$('ai-suggest-minutes').textContent;
             $('extend-minutes').value = mins;
             $('extend-btn').click();
             $('ai-suggestion-box').classList.add('hidden');
        };

        // --- è‡ªå‹•ç›£è€ƒ ---
        $('auto-pilot-btn').onclick = async () => {
            if (!state.running) return;
            state.autoPilot = true;
            $('auto-status').classList.remove('hidden');
            setControlsEnabled(false);
            $('end-exam-btn').disabled = false;
            log("ğŸ¤– --- è‡ªå‹•ç›£è€ƒæ¨¡å¼å•Ÿå‹• ---", 'ai');

            while (state.autoPilot && state.running) {
                await new Promise(r => setTimeout(r, 800));
                if (!state.autoPilot) break;

                const unf = $('inquire-btn').click();
                if (unf <= 0) {
                    log("ğŸ¤– AI åˆ¤æ–·ï¼šæ‰€æœ‰äººå·²å®Œæˆï¼Œæ”¶å·ã€‚", 'ai');
                    $('end-exam-btn').click();
                    break;
                }

                const analysis = getAIAnalysis();
                
                // å¢åŠ ä¸€å€‹å¼·åˆ¶æ”¶å·çš„æ¢ä»¶ï¼šåœ¨æ¥µç«¯å°¾éƒ¨ï¼ˆå°‘æ–¼3äººï¼‰é€£çºŒå¡ä½è¶…é 3 æ¬¡
                if (analysis.n_unf < 3 && state.inquiries > 8 && state.sameInquiryCountTimes >= 3) {
                     log(`ğŸ¤– AI åˆ¤æ–·ï¼šå‰©é¤˜ ${analysis.n_unf} äººç‚ºæ¥µç«¯ç•°å¸¸å€¼ï¼Œç‚ºé¡§åŠå…¨é«”ï¼Œå¼·åˆ¶æ”¶å·ã€‚`, 'ai');
                     $('end-exam-btn').click();
                     break;
                }

                log(`ğŸ¤– AI å»ºè­°å»¶é•· ${analysis.suggest_extend} åˆ†é˜ã€‚`, 'ai');
                await new Promise(r => setTimeout(r, 500));
                $('extend-minutes').value = analysis.suggest_extend;
                $('extend-btn').click();
            }
        };

        // --- ä¿®å¾©å¾Œçš„è¤‡è£½æ—¥èªŒåŠŸèƒ½ (v2.1.1 å°å…¥) ---
        $('copy-log-btn').onclick = () => {
            const logText = Array.from($('log-area').children)
                                .map(entry => entry.innerText.replace(/\n/g, ' '))
                                .join('\n');
            
            // å‰µå»ºä¸€å€‹éš±è—çš„ textarea ä¾†é¸å–å’Œè¤‡è£½æ–‡å­—
            const textarea = document.createElement('textarea');
            textarea.value = logText;
            textarea.style.position = 'fixed'; 
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy'); 
                const originalText = $('copy-log-btn').innerHTML;
                $('copy-log-btn').innerHTML = 'âœ… å·²è¤‡è£½ï¼';
                setTimeout(() => $('copy-log-btn').innerHTML = originalText, 2000);
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ—¥èªŒå…§å®¹ã€‚');
                console.error('Copy failed', err);
            } finally {
                document.body.removeChild(textarea);
            }
        };

    </script>
</body>
</html>
