<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>æ—¥æœŸå€’æ•¸æ©Ÿ</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="css/style.css">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å€’æ•¸æ©Ÿ">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  <meta name="theme-color" content="#007aff">
</head>
<body>

  <div id="app-container">
    
    <main id="main-content">
      
      <section id="page-home" class="page active">
        <h1 class="page-title">é¦–é ç²¾é¸</h1>
        <div id="home-filter" class="filter-bar"></div>
        <div id="home-list"></div>
      </section>

      <section id="page-all" class="page">
        <h1 class="page-title">å…¨éƒ¨æ´»å‹•</h1>
        <div id="all-filter" class="filter-bar"></div>
        <button id="toggle-archived-btn" class="toggle-archived-btn"></button>
        <div id="all-list"></div>
      </section>

      <section id="page-settings" class="page">
        <h1 class="page-title">è¨­å®š</h1>
        
        <div class="settings-group" id="notification-settings-group">
          <div class="settings-item">
            <span class="settings-item-label">æ¯æ—¥é€šçŸ¥æ™‚é–“</span>
            <input type="time" id="notify-time-input" class="settings-input-time" value="08:00">
          </div>
          <div class="settings-item">
            <button id="btn-test-notification">æ¸¬è©¦ç™¼é€é€šçŸ¥</button>
          </div>
          <div class="settings-item" style="cursor: default;">
             <p style="font-size: 0.8rem; color: var(--color-text-secondary);">æ³¨æ„ï¼šæ’ç¨‹é€šçŸ¥åƒ…åœ¨æ‚¨ä¸‹æ¬¡æ–¼è¨­å®šæ™‚é–“ (ä¾‹å¦‚ 08:00) ä¹‹å¾Œã€Œé–‹å•Ÿ App æ™‚ã€æ‰æœƒè§¸ç™¼æª¢æŸ¥ã€‚</p>
          </div>
        </div>
        
        <div class="settings-group">
          <div class="settings-item" id="btn-manage-labels">
            <span class="settings-item-label">æ¨™ç±¤ç®¡ç†</span>
            <span class="settings-item-value">â–¶</span>
          </div>
          <div class="settings-item" id="btn-manage-presets">
            <span class="settings-item-label">ç®¡ç†é è¨­æ´»å‹•é›†</span>
            <span class="settings-item-value">â–¶</span>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-item">
             <button>åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ (JSON)</button>
          </div>
          <div class="settings-item">
            <span class="settings-item-label">æ¸…ç†æ‰€æœ‰å·²å°å­˜</span>
             <button class="danger" id="btn-clear-archived">ç«‹å³æ¸…ç†</button>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-item">
            <span class="settings-item-label">ç‰ˆæœ¬è™Ÿ</span>
            <span class="settings-item-value">v1.3.2 (2025-11-03)</span>
          </div>
        </div>

      </section>
      
      <section id="page-manage-labels" class="page">
        <h1 class="page-title">æ¨™ç±¤ç®¡ç†</h1>
        <div id="labels-list"></div>
        <div class="form-group" style="padding-top: 16px;">
            <label>æ–°å¢æ¨™ç±¤</label>
            <input type="text" id="new-label-input" placeholder="æ¨™ç±¤åç¨±">
        </div>
        <div class="form-buttons">
            <button id="btn-add-label" class="form-btn btn-primary">æ–°å¢</button>
        </div>
        <div class="form-buttons" style="margin-top: 16px;">
            <button data-back-target="page-settings" class="form-btn btn-secondary btn-back">è¿”å›è¨­å®š</button>
        </div>
      </section>

      <section id="page-manage-presets" class="page">
        <h1 class="page-title">é è¨­é›†ç®¡ç†</h1>
        <p style="margin-bottom: 16px; color: var(--color-text-secondary);">
          é–‹å•Ÿé–‹é—œå¯å°‡é è¨­æ´»å‹•è¼‰å…¥åˆ°æ‚¨çš„ã€Œå…¨éƒ¨ã€é é¢ï¼Œä¸¦å¯éš¨æ™‚é—œé–‰éš±è—ã€‚é–‹å•Ÿæ™‚æœƒè‡ªå‹•åŒæ­¥æœ€æ–°è³‡æ–™ã€‚
        </p>
        <div id="preset-management-list" class="settings-group">
            </div>
        <div class="form-buttons">
            <button data-back-target="page-settings" class="form-btn btn-secondary btn-back">è¿”å›è¨­å®š</button>
        </div>
      </section>
      
    </main>

    <button id="fab-add" class="fab" style="display: none;">+</button>

    <nav class="nav-bar">
      <button class="nav-tab active" data-page="page-home">
        <span class="icon">ğŸ </span>
        <span class="label">é¦–é </span>
      </button>
      <button class="nav-tab" data-page="page-all">
        <span class="icon">ğŸ“‹</span>
        <span class="label">å…¨éƒ¨</span>
      </button>
      <button class="nav-tab" data-page="page-settings">
        <span class="icon">âš™ï¸</span>
        <span class="label">è¨­å®š</span>
      </button>
    </nav>
  </div>

  <div id="modal-detail-view" class="modal-form" style="display: none;">
    <div id="modal-detail-content" class="form-content modal-detail-content">
      <h2 id="detail-title"></h2>
      <div id="event-detail-window">
        </div>
      <div class="detail-actions">
          <button id="btn-detail-close" class="form-btn btn-secondary">é—œé–‰</button>
          <button id="btn-detail-toggle-pin" class="form-btn btn-primary" data-pinned="false"></button>
          <button id="btn-detail-notify" class="form-btn btn-secondary">ğŸ”” é€šçŸ¥</button>
          <button id="btn-detail-edit" class="form-btn btn-primary">ç·¨è¼¯</button>
      </div>
    </div>
  </div>


  <div id="modal-add-event" class="modal-form" style="display: none;">
    <div class="form-content modal-form-content">
      <h2 id="form-title">æ–°å¢æ´»å‹•</h2>
      <input type="hidden" id="event-id">
      <input type="hidden" id="event-preset-id"> 
      
      <div class="form-group">
        <label for="event-title">æ¨™é¡Œ (å¿…å¡«)</label>
        <input type="text" id="event-title" placeholder="ä¾‹å¦‚ï¼šæœƒè€ƒå€’æ•¸">
      </div>
      
      <div class="form-group">
        <label for="event-date">ç›®æ¨™æ—¥æœŸ (å¿…å¡«)</label>
        <input type="date" id="event-date">
      </div>
      
      <div class="form-group">
        <label for="event-subtitle">å‰¯æ¨™é¡Œ (é¸å¡«)</label>
        <input type="text" id="event-subtitle" placeholder="ä¾‹å¦‚ï¼šæº–å‚™å‡†è€ƒè­‰">
      </div>
      
      <div class="form-group">
        <label>æ¨™ç±¤ (å¯å¤šé¸)</label>
        <div id="form-labels-container" class="form-labels-container">
          </div>
      </div>

      <div class="form-group">
        <label>é‡è¤‡é€±æœŸ (é¸å¡«)</label>
        <div class="form-recurrence-container">
          <span style="font-size: 0.9rem; margin-right: 5px;">æ¯</span>
          <input type="number" id="event-recurrence-interval" value="1" min="1">
          <select id="event-recurrence-unit">
            <option value="None">æ°¸ä¸</option>
            <option value="Weekly">é€±</option>
            <option value="Monthly">æœˆ</option>
            <option value="Yearly">å¹´</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="event-color">äº‹ä»¶é™°å½±é¡è‰² (é¸å¡«)</label>
        <input type="color" id="event-color" value="#007aff" style="width: 100px;">
      </div>

      <div class="form-group-inline">
        <label for="event-pinned">å®šé¸è‡³é¦–é </label>
        <input type="checkbox" id="event-pinned" class="form-toggle">
      </div>

      <div class="form-buttons">
        <button id="btn-form-cancel" class="form-btn btn-secondary">å–æ¶ˆ</button>
        <button id="btn-form-save" class="form-btn btn-primary">å„²å­˜</button>
      </div>
      
      <div class="form-buttons" style="margin-top: 0;">
         <button id="btn-form-delete" class="form-btn danger" style="width: 100%; display: none;">åˆªé™¤æ´»å‹•</button>
      </div>
    </div>
  </div>
  
  <div id="modal-notification" class="modal-form" style="display: none;">
    <div class="form-content">
      <h2 id="notify-form-title"></h2>
      <div class="form-group-inline">
        <label for="notify-daily">æ¯æ—¥é€šçŸ¥</label>
        <input type="checkbox" id="notify-daily" class="form-toggle">
      </div>
      <div class="form-group">
        <label for="notify-specific">ç‰¹å®šå€’æ•¸å¤©æ•¸é€šçŸ¥ (ç”¨é€—è™Ÿåˆ†éš”)</label>
        <input type="text" id="notify-specific" placeholder="ä¾‹å¦‚: 30, 7, 1">
      </div>
      <div class="form-buttons">
        <button id="btn-notify-cancel" class="form-btn btn-secondary">å–æ¶ˆ</button>
        <button id="btn-notify-save" class="form-btn btn-primary">å„²å­˜</button>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. ç‹€æ…‹èˆ‡å¸¸æ•¸ (v1.3.1) ---
      const STORAGE_KEY = 'countdownEvents_v1_stable';
      const CONFIG_KEY = 'countdownConfig_v1_stable';
      
      const OLD_STORAGE_KEY_v1_3 = 'countdownEvents_v1.3';
      const OLD_CONFIG_KEY_v1_3 = 'countdownConfig_v1.3';
      
      const DEFAULT_COLOR = '#007aff';
      
      let events = []; 
      let config = {
          presets: {}, 
          labels: ['è€ƒè©¦', 'å·¥ä½œ', 'ç”Ÿæ—¥', 'æ—…è¡Œ'], 
          notificationTime: '08:00',
      }; 
      
      let currentFilter = { home: ['å…¨éƒ¨'], all: ['å…¨éƒ¨'] }; 
      let showArchived = false;
      let currentEventId = null; 
      
      const availablePresets = [
        { id: 'holidays', name: 'åœ‹å®šç¯€æ—¥èˆ‡ç´€å¿µæ—¥', path: './assets/default_data/national_holidays.json' },
        { id: 'exams', name: 'å­¸ç§‘è€ƒè©¦', path: './assets/default_data/school_exams.json' },
      ];


      // --- 2. DOM å…ƒç´  ---
      const pages = document.querySelectorAll('.page');
      const navTabs = document.querySelectorAll('.nav-tab');
      const fab = document.getElementById('fab-add');
      const homeList = document.getElementById('home-list');
      const allList = document.getElementById('all-list');
      const homeFilter = document.getElementById('home-filter');
      const allFilter = document.getElementById('all-filter');
      const toggleArchivedBtn = document.getElementById('toggle-archived-btn');
      const modalDetail = document.getElementById('modal-detail-view');
      const detailTitle = document.getElementById('detail-title');
      const detailWindow = document.getElementById('event-detail-window');
      const btnDetailClose = document.getElementById('btn-detail-close');
      const btnDetailTogglePin = document.getElementById('btn-detail-toggle-pin');
      const btnDetailEdit = document.getElementById('btn-detail-edit');
      const btnDetailNotify = document.getElementById('btn-detail-notify');
      const modalForm = document.getElementById('modal-add-event');
      const formTitle = document.getElementById('form-title');
      const formEventId = document.getElementById('event-id');
      const formPresetId = document.getElementById('event-preset-id');
      const formTitleInput = document.getElementById('event-title');
      const formDateInput = document.getElementById('event-date');
      const formSubtitleInput = document.getElementById('event-subtitle');
      const formLabelsContainer = document.getElementById('form-labels-container');
      const formRecurrenceIntervalInput = document.getElementById('event-recurrence-interval');
      const formRecurrenceUnitInput = document.getElementById('event-recurrence-unit');
      const formPinnedInput = document.getElementById('event-pinned');
      const formColorInput = document.getElementById('event-color');
      const btnFormCancel = document.getElementById('btn-form-cancel');
      const btnFormSave = document.getElementById('btn-form-save');
      const btnFormDelete = document.getElementById('btn-form-delete');
      const modalNotification = document.getElementById('modal-notification');
      const notifyFormTitle = document.getElementById('notify-form-title');
      const notifyDaily = document.getElementById('notify-daily');
      const notifySpecific = document.getElementById('notify-specific');
      const btnNotifyCancel = document.getElementById('btn-notify-cancel');
      const btnNotifySave = document.getElementById('btn-notify-save');
      const btnManageLabels = document.getElementById('btn-manage-labels');
      const btnManagePresets = document.getElementById('btn-manage-presets');
      const btnClearArchived = document.getElementById('btn-clear-archived');
      const notifyTimeInput = document.getElementById('notify-time-input');
      const btnTestNotification = document.getElementById('btn-test-notification');
      const labelsList = document.getElementById('labels-list');
      const newLabelInput = document.getElementById('new-label-input');
      const btnAddLabel = document.getElementById('btn-add-label');
      const presetManagementList = document.getElementById('preset-management-list');
      
      // --- 3. æ ¸å¿ƒé‚è¼¯ (æ—¥æœŸè¨ˆç®—èˆ‡è³‡æ–™) ---

      /** è¼‰å…¥è³‡æ–™ (v1.3.1 é·ç§»é‚è¼¯) */
      function loadData() {
        let eventData = localStorage.getItem(STORAGE_KEY);
        let configData = localStorage.getItem(CONFIG_KEY);

        // v1.3.1 è³‡æ–™é·ç§»é‚è¼¯
        if (!eventData) {
            console.log('Stable storage not found. Attempting migration from v1.3...');
            eventData = localStorage.getItem(OLD_STORAGE_KEY_v1_3);
            if (eventData) {
                console.log('Migrating events data from v1.3...');
                localStorage.setItem(STORAGE_KEY, eventData);
                localStorage.removeItem(OLD_STORAGE_KEY_v1_3);
            }
        }
        if (!configData) {
            console.log('Stable config not found. Attempting migration from v1.3...');
            configData = localStorage.getItem(OLD_CONFIG_KEY_v1_3);
            if (configData) {
                console.log('Migrating config data from v1.3...');
                localStorage.setItem(CONFIG_KEY, configData);
                localStorage.removeItem(OLD_CONFIG_KEY_v1_3);
            }
        }
        
        events = eventData ? JSON.parse(eventData) : [];
        if (configData) {
            const savedConfig = JSON.parse(configData);
            config = { ...config, ...savedConfig };
            if (!config.presets) config.presets = {}; 
            if (!config.labels) config.labels = ['è€ƒè©¦', 'å·¥ä½œ', 'ç”Ÿæ—¥', 'æ—…è¡Œ'];
            if (!config.notificationTime) config.notificationTime = '08:00';
        }
        
        notifyTimeInput.value = config.notificationTime;
      }

      /** å„²å­˜è³‡æ–™ */
      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
      }

      /** ç”¢ç”Ÿå”¯ä¸€ ID */
      function generateID() {
        return 'id_' + Math.random().toString(36).substr(2, 9);
      }
      
      /** æª¢æŸ¥ä¸¦è‡ªå‹•å°å­˜éæœŸæ´»å‹• (v1.3.0 é‚è¼¯) */
      function checkAndArchiveEvents() {
        let needsSave = false;
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        
        events.forEach(event => {
          if (event.status !== 'Active') return;
          
          const targetDate = new Date(event.date + 'T00:00:00');
          const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

          if (diffDays < 0) {
            if (event.recurrence && event.recurrence.unit !== 'None') {
              let newDate = targetDate;
              const unit = event.recurrence.unit;
              const interval = event.recurrence.interval || 1;
              
              while (newDate < today) {
                if (unit === 'Yearly') {
                  newDate.setFullYear(newDate.getFullYear() + interval);
                } else if (unit === 'Monthly') {
                  newDate.setMonth(newDate.getMonth() + interval);
                } else if (unit === 'Weekly') {
                  newDate.setDate(newDate.getDate() + (7 * interval));
                } else {
                    break; 
                }
              }
              event.date = newDate.toISOString().split('T')[0];
              needsSave = true;
            } else {
              event.status = 'Archived';
              event.is_pinned = false;
              needsSave = true;
            }
          }
        });

        if (needsSave) saveData();
      }

      /** è¨ˆç®—å€’æ•¸å¤©æ•¸ */
      function calculateCountdown(dateStr) {
        const targetDate = new Date(dateStr + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return { days: 'ä»Š', unit: 'å¤©', status: 'today' };
        if (diffDays < 0) return { days: Math.abs(diffDays), unit: 'å¤©å‰', status: 'expired' };
        return { days: diffDays, unit: 'å¤©', status: 'pending' };
      }

      // --- 4. æ¸²æŸ“é‚è¼¯ (UI) ---

      /** å–å¾—äº‹ä»¶çš„é¡è‰² */
      function getEventColor(event) {
          if (event.color) return event.color;
          if (event.presetId && config.presets[event.presetId] && config.presets[event.presetId].color) {
              return config.presets[event.presetId].color;
          }
          return DEFAULT_COLOR; 
      }

      /** ç”¢ç”Ÿå–®å€‹å¡ç‰‡çš„ HTML (v1.3.0 é‚è¼¯) */
      function createEventCardHTML(event) {
        const countdown = calculateCountdown(event.date);
        const eventColor = getEventColor(event);
        
        const hasNotification = event.notification && (event.notification.daily || (event.notification.specificDays && event.notification.specificDays.length > 0));
        const notifyIcon = hasNotification ? '<span class="notification-icon">ğŸ””</span> ' : '';
        
        const labelsHTML = (event.labels || [])
          .map(label => `<span class="card-label">${label}</span>`)
          .join(' ');
        
        let countdownHTML;
        if (event.status === 'Archived') {
          countdownHTML = `<span class="countdown-expired">å·²å°å­˜</span>`;
        } else if (countdown.status === 'expired') {
            countdownHTML = `<div class="countdown-days">${countdown.days}</div><div class="countdown-unit">${countdown.unit}</div>`;
        } else {
           countdownHTML = `<div class="countdown-days">${countdown.days}</div><div class="countdown-unit">${countdown.unit}</div>`;
        }

        return `
          <div 
            class="event-card ${event.status === 'Archived' ? 'archived' : ''}" 
            data-id="${event.id}"
            style="--shadow-color: ${eventColor};"
          >
            <div class="card-details">
              ${notifyIcon || labelsHTML ? `<div class="card-labels">${notifyIcon}${labelsHTML}</div>` : ''}
              <div class="card-title">${event.title}</div>
              ${event.subtitle ? `<div class="card-subtitle">${event.subtitle}</div>` : ''}
              <div class="card-date">${event.date}</div>
            </div>
            <div class="card-countdown">
              ${countdownHTML}
            </div>
          </div>
        `;
      }
      
      /** æ¸²æŸ“ç¯©é¸å™¨ (v1.3.0 é‚è¼¯) */
      function renderFilterBar(page, container) {
          const isHome = page === 'home';
          const current = currentFilter[page];
          
          const allLabels = events
            .filter(e => isHome ? e.is_pinned && e.status === 'Active' : e.status === 'Active')
            .reduce((acc, e) => {
                (e.labels || []).forEach(label => acc.add(label));
                return acc;
            }, new Set());

          const availableLabels = ['å…¨éƒ¨', ...Array.from(allLabels)].sort();
          
          container.innerHTML = availableLabels.map(label => `
              <div 
                  class="filter-chip ${current.includes(label) ? 'selected' : ''}" 
                  data-label="${label}"
                  data-page="${page}"
              >
                  ${label}
              </div>
          `).join('');
      }

      /** å–å¾—éæ¿¾å¾Œçš„æ´»å‹• (v1.3.0 é‚è¼¯) */
      function getFilteredEvents(page) {
        const isHome = page === 'home';
        const filterLabels = currentFilter[page];
        const statusToShow = (page === 'all' && showArchived) ? 'Archived' : 'Active';

        let filtered = events
          .filter(e => {
            if (isHome) {
              return e.is_pinned && e.status === 'Active';
            }
            return e.status === statusToShow;
          })
          .filter(e => {
            if (e.presetId && config.presets[e.presetId]) {
              return config.presets[e.presetId].isVisible === undefined ? true : config.presets[e.presetId].isVisible;
            }
            return true; 
          });

        if (!filterLabels.includes('å…¨éƒ¨')) {
          filtered = filtered.filter(e => {
            if (!e.labels || e.labels.length === 0) return false;
            return e.labels.some(label => filterLabels.includes(label));
          });
        }
        
        return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
      }

      /** æ¸²æŸ“é¦–é  */
      function renderHomePage() {
        renderFilterBar('home', homeFilter);
        const filteredEvents = getFilteredEvents('home');

        if (filteredEvents.length === 0) {
          homeList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“Œ</div><p>å°šç„¡å®šé¸æ´»å‹•æˆ–ç¯©é¸çµæœç‚ºç©º</p><p>è«‹è‡³ã€Œå…¨éƒ¨ã€é é¢æ–°å¢æˆ–å®šé¸æ´»å‹•</p></div>`;
        } else {
          homeList.innerHTML = filteredEvents.map(createEventCardHTML).join('');
        }
      }

      /** æ¸²æŸ“å…¨éƒ¨é é¢ */
      function renderAllPage() {
        renderFilterBar('all', allFilter);
        const filteredEvents = getFilteredEvents('all');

        if (filteredEvents.length === 0) {
          allList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${showArchived ? 'ğŸ—„ï¸' : 'ğŸ‰'}</div><p>${showArchived ? 'å°å­˜å€æ˜¯ç©ºçš„' : 'ç›®å‰æ²’æœ‰æ´»å‹•æˆ–ç¯©é¸çµæœç‚ºç©º'}</p>${!showArchived ? '<p>é»æ“Šå³ä¸‹è§’ + é–‹å§‹æ–°å¢</p>' : ''}</div>`;
        } else {
          allList.innerHTML = filteredEvents.map(createEventCardHTML).join('');
        }
        
        const archivedCount = events.filter(e => e.status === 'Archived').length;
        toggleArchivedBtn.textContent = `${showArchived ? 'éš±è—' : 'é¡¯ç¤º'}å·²å°å­˜ (${archivedCount})`;
      }
      
      /** æ¸²æŸ“æ¨™ç±¤ç®¡ç†é é¢ */
      function renderLabelManagement() {
          labelsList.innerHTML = (config.labels || []).map(label => `
              <div class="settings-item">
                  <span class="settings-item-label">${label}</span>
                  <button data-label="${label}" class="danger" style="width: auto;">åˆªé™¤</button>
              </div>
          `).join('');
          
          labelsList.querySelectorAll('button.danger').forEach(btn => {
              btn.addEventListener('click', (e) => {
                  const labelToDelete = e.target.dataset.label;
                  if (confirm(`ç¢ºå®šè¦åˆªé™¤æ¨™ç±¤ "${labelToDelete}" å—ï¼Ÿ`)) {
                      config.labels = config.labels.filter(l => l !== labelToDelete);
                      saveData();
                      renderLabelManagement();
                      renderAllPages(); 
                  }
              });
          });
      }
      
      /** æ¸²æŸ“é è¨­é›†ç®¡ç†é é¢ (v1.3.0 é‚è¼¯) */
      function renderPresetManagementPage() {
          presetManagementList.innerHTML = availablePresets.map(preset => {
              const presetConfig = config.presets[preset.id] || {};
              const isVisible = presetConfig.isVisible === undefined ? false : presetConfig.isVisible; 
              const color = presetConfig.color || DEFAULT_COLOR;

              return `
                  <div class="preset-item" data-id="${preset.id}">
                      <span class="preset-name">${preset.name}</span>
                      <div class="preset-controls">
                          <input type="color" value="${color}" class="preset-color-picker" data-id="${preset.id}" ${!isVisible ? 'disabled' : ''}>
                          <input type="checkbox" ${isVisible ? 'checked' : ''} class="form-toggle preset-toggle" data-id="${preset.id}">
                      </div>
                  </div>
              `;
          }).join('');
          
          presetManagementList.querySelectorAll('.preset-color-picker').forEach(input => {
              input.addEventListener('change', (e) => {
                  const presetId = e.target.dataset.id;
                  if (!config.presets[presetId]) config.presets[presetId] = {}; 
                  config.presets[presetId].color = e.target.value;
                  saveData();
                  renderAllPages(); 
              });
          });

          presetManagementList.querySelectorAll('.preset-toggle').forEach(toggle => {
              toggle.addEventListener('click', (e) => {
                  const presetId = e.target.dataset.id;
                  const isVisible = e.target.checked;
                  handlePresetToggle(presetId, isVisible, e.target); // å‚³å…¥ e.target
                  e.target.closest('.preset-item').querySelector('.preset-color-picker').disabled = !isVisible;
              });
          });
      }

      /** æ¸²æŸ“æ‰€æœ‰é é¢ (ä¸»å‡½æ•¸) */
      function renderAllPages() {
        renderHomePage();
        renderAllPage();
      }


      // --- 5. æ¨¡æ…‹è¦–çª—èˆ‡è¡¨å–®é‚è¼¯ ---

      /** é¡¯ç¤ºè©³ç´°è³‡æ–™è¦–çª— */
      function showDetailModal(event) {
          currentEventId = event.id; 
          detailTitle.textContent = event.title;
          btnDetailTogglePin.textContent = event.is_pinned ? 'å–æ¶ˆå®šé¸' : 'å®šé¸åˆ°é¦–é ';
          btnDetailTogglePin.dataset.pinned = event.is_pinned;

          const eventColor = getEventColor(event);
          const recurrence = event.recurrence || { unit: 'None', interval: 1 };
          let recurrenceText = 'æ°¸ä¸';
          if (recurrence.unit !== 'None') {
              recurrenceText = `æ¯ ${recurrence.interval} ${ {'Weekly':'é€±','Monthly':'æœˆ','Yearly':'å¹´'}[recurrence.unit] }`;
          }
          
          const content = `
              <div class="detail-item">
                  <span class="detail-item-label">å€’æ•¸</span>
                  <span class="detail-item-value">${calculateCountdown(event.date).days} ${calculateCountdown(event.date).unit}</span>
              </div>
              <div class="detail-item">
                  <span class="detail-item-label">ç›®æ¨™æ—¥æœŸ</span>
                  <span class="detail-item-value">${event.date}</span>
              </div>
              ${event.subtitle ? `<div class="detail-item"><span class="detail-item-label">å‰¯æ¨™é¡Œ</span><span class="detail-item-value">${event.subtitle}</span></div>` : ''}
              ${(event.labels && event.labels.length > 0) ? `<div class="detail-item"><span class="detail-item-label">æ¨™ç±¤</span><span class="detail-item-value">${event.labels.join(', ')}</span></div>` : ''}
              <div class="detail-item">
                  <span class="detail-item-label">é‡è¤‡é€±æœŸ</span>
                  <span class="detail-item-value">${recurrenceText}</span>
              </div>
              ${event.presetId ? `<div class="detail-item"><span class="detail-item-label">æ‰€å±¬é è¨­é›†</span><span class="detail-item-value">${config.presets[event.presetId]?.name || 'æœªçŸ¥'}</span></div>` : ''}
              <div class="detail-item">
                  <span class="detail-item-label">é™°å½±é¡è‰²</span>
                  <span class="detail-item-value" style="color: ${eventColor};">${eventColor}</span>
              </div>
          `;
          detailWindow.innerHTML = content;
          modalDetail.style.display = 'flex';
      }

      /** é¡¯ç¤ºæ–°å¢/ç·¨è¼¯è¦–çª— */
      function showFormModal(event = null) {
        const isPresetEvent = !!(event && event.presetId);
        
        if (event) {
          formTitle.textContent = 'ç·¨è¼¯æ´»å‹•';
          formEventId.value = event.id;
          formPresetId.value = event.presetId || '';
          formTitleInput.value = event.title;
          formDateInput.value = event.date;
          formSubtitleInput.value = event.subtitle || '';
          
          const recurrence = event.recurrence || { unit: 'None', interval: 1 };
          formRecurrenceIntervalInput.value = recurrence.interval || 1;
          formRecurrenceUnitInput.value = recurrence.unit || 'None';
          
          formPinnedInput.checked = event.is_pinned;
          formColorInput.value = event.color || getEventColor(event);
          btnFormDelete.style.display = isPresetEvent ? 'none' : 'block'; 
          
        } else {
          formTitle.textContent = 'æ–°å¢æ´»å‹•';
          formEventId.value = '';
          formPresetId.value = '';
          formTitleInput.value = '';
          formDateInput.value = '';
          formSubtitleInput.value = '';
          formRecurrenceIntervalInput.value = 1;
          formRecurrenceUnitInput.value = 'None';
          formPinnedInput.checked = false;
          formColorInput.value = DEFAULT_COLOR;
          btnFormDelete.style.display = 'none';
        }
        
        const currentLabels = (event && event.labels) ? event.labels : [];
        formLabelsContainer.innerHTML = (config.labels || []).map(label => `
          <div class="label-checkbox-item">
            <input type="checkbox" id="label-cb-${label}" class="label-checkbox-input" value="${label}" ${currentLabels.includes(label) ? 'checked' : ''}>
            <label for="label-cb-${label}">${label}</label>
          </div>
        `).join('');
        
        formTitleInput.disabled = isPresetEvent;
        formDateInput.disabled = isPresetEvent;
        formColorInput.disabled = isPresetEvent;
        formRecurrenceIntervalInput.disabled = isPresetEvent;
        formRecurrenceUnitInput.disabled = isPresetEvent;

        modalDetail.style.display = 'none'; 
        modalForm.style.display = 'flex';
      }
      
      function hideDetailModal() { 
          modalDetail.style.display = 'none'; 
          currentEventId = null; 
      }
      function hideFormModal() { 
          modalForm.style.display = 'none'; 
          currentEventId = null; 
      }
      function hideNotificationModal() { 
          modalNotification.style.display = 'none'; 
          // v1.3.1: é—œé–‰é€šçŸ¥è¦–çª—æ™‚ *ä¸æ¸…é™¤* IDï¼Œé€™æ¨£æ‰èƒ½å„²å­˜
          // v1.3.2 ä¿®æ­£: æ‡‰è©²åœ¨ "å–æ¶ˆ" æˆ– "å„²å­˜" æ™‚æ¸…é™¤
      }

      /** åˆªé™¤æ´»å‹• */
      function handleDelete() {
        const id = formEventId.value;
        if (!id) return;

        if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
          events = events.filter(e => e.id !== id);
          saveData();
          renderAllPages();
          hideFormModal();
        }
      }
      
      /** æäº¤è¡¨å–® */
      function handleFormSubmit() {
        const id = formEventId.value;
        const title = formTitleInput.value.trim();
        const date = formDateInput.value;

        if (!title || !date) {
          alert('è«‹è¼¸å…¥æ¨™é¡Œå’Œæ—¥æœŸï¼');
          return;
        }
        
        const selectedLabels = Array.from(document.querySelectorAll('#form-labels-container input[type="checkbox"]:checked'))
                                    .map(cb => cb.value);
        
        const recurrenceUnit = formRecurrenceUnitInput.value;
        const recurrenceInterval = parseInt(formRecurrenceIntervalInput.value) || 1;
        const recurrence = (recurrenceUnit !== 'None') ? { unit: recurrenceUnit, interval: recurrenceInterval } : { unit: 'None', interval: 1 };
        
        const presetId = formPresetId.value || undefined;
        let originalEvent = null;
        if (id) {
            originalEvent = events.find(e => e.id === id);
        }

        const eventData = {
          id: id || generateID(),
          title: title,
          subtitle: formSubtitleInput.value.trim() || '',
          date: date,
          labels: selectedLabels,
          recurrence: recurrence,
          is_pinned: formPinnedInput.checked,
          color: formColorInput.value !== DEFAULT_COLOR ? formColorInput.value : undefined,
          presetId: presetId,
          notification: (originalEvent && originalEvent.notification) ? originalEvent.notification : undefined,
          status: 'Active' 
        };
        
        if (presetId && originalEvent) {
            eventData.title = originalEvent.title;
            eventData.date = originalEvent.date;
            eventData.recurrence = originalEvent.recurrence;
            eventData.color = originalEvent.color; 
            eventData.subtitle = formSubtitleInput.value.trim() || ''; 
            eventData.labels = selectedLabels;
            eventData.is_pinned = formPinnedInput.checked;
        }

        if (id) {
          const index = events.findIndex(e => e.id === id);
          if (index > -1) {
            events[index] = { ...events[index], ...eventData };
          }
        } else {
          events.push(eventData);
        }

        saveData();
        renderAllPages();
        hideFormModal();
      }
      
      /** è™•ç†é è¨­é›†é¡¯ç¤º/éš±è—åˆ‡æ› (v1.3.2 ä¿®æ­£ Bug 1 & 3) */
      async function handlePresetToggle(presetId, isVisible, toggleElement) {
          const preset = availablePresets.find(p => p.id === presetId);
          if (!preset) return;

          if (!config.presets[presetId]) {
              config.presets[presetId] = { name: preset.name, color: DEFAULT_COLOR, isVisible: false };
          }
          config.presets[presetId].isVisible = isVisible;
          
          let needsDataFetch = false;
          // v1.3.2: åªè¦é–‹å•Ÿï¼Œå°±å¼·åˆ¶é‡æ–°æŠ“å– (åŒæ­¥)
          if (isVisible) {
              needsDataFetch = true;
          }

          if (needsDataFetch) {
              console.log(`Syncing preset: ${preset.name}`);
              try {
                  // v1.3.2 Bug 1 ä¿®æ­£: å¼·åˆ¶ bypass å¿«å–
                  const response = await fetch(preset.path, { cache: 'no-cache' }); 
                  if (!response.ok) throw new Error(`ç„¡æ³•è¼‰å…¥ ${preset.name}`);
                  
                  const defaultEvents = await response.json();
                  
                  // v1.3.2 Bug 1 ä¿®æ­£: åˆªé™¤èˆŠçš„
                  events = events.filter(e => e.presetId !== presetId);
                  
                  let newLabelsFound = new Set();
                  
                  defaultEvents.forEach(event => {
                      events.push({
                          ...event,
                          id: generateID(),
                          status: 'Active',
                          presetId: preset.id,
                      });
                      
                      // v1.3.2 Bug 3: æ”¶é›†æ¨™ç±¤
                      if (event.labels && event.labels.length > 0) {
                          event.labels.forEach(label => newLabelsFound.add(label));
                      }
                  });
                  
                  // v1.3.2 Bug 3: åŒæ­¥æ¨™ç±¤
                  newLabelsFound.forEach(label => {
                      if (!config.labels.includes(label)) {
                          config.labels.push(label);
                      }
                  });
                  
                  checkAndArchiveEvents();
                  
              } catch (error) {
                  console.error('å°å…¥å¤±æ•—:', error);
                  alert(`å°å…¥é è¨­é›† ${preset.name} å¤±æ•—ã€‚`);
                  config.presets[presetId].isVisible = false;
                  if (toggleElement) toggleElement.checked = false; // æ¢å¾©åˆ‡æ›
              }
          }

          saveData();
          renderAllPages();
      }
      
      
      // --- 6. v1.3.2 é€šçŸ¥é‚è¼¯ (ä¿®æ­£ Bug 2) ---
      
      /** è«‹æ±‚é€šçŸ¥æ¬Šé™ (App å•Ÿå‹•æ™‚) */
      function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
          setTimeout(() => {
             Notification.requestPermission();
          }, 3000); 
        }
      }
      
      /** é¡¯ç¤ºé€šçŸ¥è¨­å®šè¦–çª— (v1.3.1) */
      function showNotificationModal() {
          const event = events.find(e => e.id === currentEventId);
          if (!event) {
              console.error('Notification modal: Event ID not found.');
              return;
          }
          
          if (Notification.permission !== 'granted') {
              alert('æ‚¨å°šæœªé–‹å•Ÿé€šçŸ¥æ¬Šé™ã€‚è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±é€šçŸ¥ã€‚');
              Notification.requestPermission();
              return;
          }
          
          notifyFormTitle.textContent = event.title;
          const settings = event.notification || { daily: false, specificDays: [] };
          notifyDaily.checked = settings.daily;
          notifySpecific.value = (settings.specificDays || []).join(', ');
          
          modalDetail.style.display = 'none';
          modalNotification.style.display = 'flex';
      }
      
      /** å„²å­˜é€šçŸ¥è¨­å®š (v1.3.1 ä¿®æ­£ Bug 2) */
      function handleNotificationSave() {
          // v1.3.1 ä¿®æ­£: å„²å­˜æ™‚ currentEventId ä»ç„¶å­˜åœ¨
          const event = events.find(e => e.id === currentEventId);
          if (!event) {
               console.error('Notification save failed: Event ID lost.');
               alert('å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚');
               currentEventId = null; // æ¸…é™¤ ID
               hideNotificationModal();
               return;
          }
          
          const specificDays = notifySpecific.value.split(',')
                                .map(s => parseInt(s.trim()))
                                .filter(n => !isNaN(n) && n > 0);
                                
          event.notification = {
            daily: notifyDaily.checked,
            specificDays: Array.from(new Set(specificDays)) 
          };
          
          console.log('Notification settings saved for:', event.title);
          saveData();
          renderAllPages();
          hideNotificationModal();
          currentEventId = null; // å„²å­˜å¾Œæ¸…é™¤ ID
      }
      
      /** å–æ¶ˆé€šçŸ¥è¨­å®š (v1.3.2 æ–°å¢) */
      function handleNotificationCancel() {
          hideNotificationModal();
          currentEventId = null; // å–æ¶ˆæ™‚æ¸…é™¤ ID
      }

      /** ç™¼é€æ¸¬è©¦é€šçŸ¥ (v1.3.2 ä¿®æ­£ Bug 2 - æ‰‹æ©Ÿ) */
      async function handleTestNotification() {
          if (!('Notification' in window) || !('serviceWorker' in navigator)) {
              alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´é€šçŸ¥åŠŸèƒ½ã€‚');
              return;
          }
          
          let permission = Notification.permission;
          if (permission === 'default') {
              permission = await Notification.requestPermission();
          }

          if (permission === 'granted') {
            sendNotification('æ¸¬è©¦é€šçŸ¥ (v1.3.2)', 'å¦‚æœçœ‹åˆ°é€™å€‹ï¼Œè¡¨ç¤ºé€šçŸ¥è¨­å®šæˆåŠŸï¼');
          } else if (permission === 'denied') {
              alert('é€šçŸ¥æ¬Šé™å·²è¢«å°é–ï¼Œè«‹è‡³ç€è¦½å™¨è¨­å®šä¸­è§£é™¤å°é–ã€‚');
          }
      }

      /** æª¢æŸ¥ä¸¦ç™¼é€æ’ç¨‹é€šçŸ¥ (App å•Ÿå‹•æ™‚) */
      function checkAndSendNotifications() {
          if (Notification.permission !== 'granted') {
              console.log('é€šçŸ¥æ¬Šé™æœªé–‹å•Ÿï¼Œè·³éæª¢æŸ¥ã€‚');
              return;
          }
          
          const today = new Date();
          const notifyTime = config.notificationTime.split(':'); 
          const now = new Date();
          
          const lastCheckStorageKey = 'lastNotificationCheck_v1.3'; 
          const lastCheckDate = localStorage.getItem(lastCheckStorageKey) || '';
          const todayStr = today.toISOString().split('T')[0];
          
          const notifyHour = parseInt(notifyTime[0]);
          const notifyMinute = parseInt(notifyTime[1]);
          
          if (now.getHours() < notifyHour || (now.getHours() === notifyHour && now.getMinutes() < notifyMinute)) {
              console.log('å°šæœªåˆ°é”ä»Šæ—¥é€šçŸ¥æ™‚é–“ã€‚');
              if(lastCheckDate) localStorage.setItem(lastCheckStorageKey, ''); 
              return;
          }
          
          if (lastCheckDate === todayStr) {
              console.log('ä»Šæ—¥å·²æª¢æŸ¥éé€šçŸ¥ã€‚');
              return;
          }
          
          console.log(`åŸ·è¡Œ ${todayStr} çš„é€šçŸ¥æª¢æŸ¥ (æ™‚é–“ ${config.notificationTime})...`);
          localStorage.setItem(lastCheckStorageKey, todayStr);

          events.forEach(event => {
            if (event.status !== 'Active' || !event.notification) return;
            
            const countdown = calculateCountdown(event.date);
            if (countdown.status === 'expired' || countdown.status === 'today') return;
            
            const daysLeft = countdown.days;
            let triggered = false;

            if (event.notification.daily) {
               sendNotification(`æ¯æ—¥æé†’: ${event.title}`, `é‚„å‰©ä¸‹ ${daysLeft} å¤©ï¼`);
               triggered = true;
            }
            if (!triggered && event.notification.specificDays && event.notification.specificDays.includes(daysLeft)) {
               sendNotification(`å€’æ•¸æé†’: ${event.title}`, `å€’æ•¸ ${daysLeft} å¤©ï¼`);
            }
          });
      }
      
      /** å¯¦éš›çš„ Web Notification API å‘¼å« (v1.3.2 ä¿®æ­£ Bug 2 - æ‰‹æ©Ÿ) */
      function sendNotification(title, body) {
          // ä¿®æ­£: é€é Service Worker ç™¼é€ï¼Œç¢ºä¿åœ¨æ‰‹æ©ŸèƒŒæ™¯ä¹Ÿèƒ½é‹ä½œ
          if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
              navigator.serviceWorker.ready.then(registration => {
                  registration.showNotification(title, {
                      body: body,
                      icon: './assets/icons/icon-192.png',
                      badge: './assets/icons/icon-72.png'
                  });
              });
          } else {
              // å‚™ç”¨æ–¹æ¡ˆ (ä¸»è¦ç”¨æ–¼ SW å°šæœªå•Ÿå‹•æ™‚çš„æ¸¬è©¦)
              new Notification(title, { 
                  body: body, 
                  icon: './assets/icons/icon-192.png',
                  badge: './assets/icons/icon-72.png'
              });
          }
      }

      // --- 7. äº‹ä»¶ç›£è½å™¨ ---

      /** ç¯©é¸å™¨äº‹ä»¶å§”æ´¾ */
      document.getElementById('main-content').addEventListener('click', (e) => {
          if (e.target.classList.contains('filter-chip')) {
              const page = e.target.dataset.page;
              const label = e.target.dataset.label;
              let current = currentFilter[page];

              if (label === 'å…¨éƒ¨') {
                  current = ['å…¨éƒ¨'];
              } else {
                  const allIndex = current.indexOf('å…¨éƒ¨');
                  if (allIndex > -1) current.splice(allIndex, 1);
                  
                  const labelIndex = current.indexOf(label);
                  if (labelIndex > -1) {
                      current.splice(labelIndex, 1);
                  } else {
                      current.push(label);
                  }
                  
                  if (current.length === 0) current = ['å…¨éƒ¨'];
              }
              currentFilter[page] = current;
              
              if (page === 'home') renderHomePage();
              if (page === 'all') renderAllPage();
          }
          
          const card = e.target.closest('.event-card');
          if (card) {
              const id = card.dataset.id;
              const event = events.find(e => e.id === id);
              if (event) showDetailModal(event);
          }
      });

      /** æ¨¡æ…‹è¦–çª—æ“ä½œ */
      btnDetailClose.addEventListener('click', hideDetailModal); 
      btnDetailEdit.addEventListener('click', () => {
          const event = events.find(e => e.id === currentEventId);
          if (event) showFormModal(event);
      });
      btnDetailTogglePin.addEventListener('click', () => {
          const event = events.find(e => e.id === currentEventId);
          if (event) {
              event.is_pinned = !event.is_pinned;
              saveData();
              renderAllPages();
              hideDetailModal(); 
          }
      });
      
      btnFormCancel.addEventListener('click', hideFormModal); 
      btnFormSave.addEventListener('click', handleFormSubmit);
      btnFormDelete.addEventListener('click', handleDelete);
      fab.addEventListener('click', () => showFormModal(null));
      
      // v1.3.2 é€šçŸ¥æ¨¡æ…‹è¦–çª— (ä¿®æ­£ Bug 2)
      btnDetailNotify.addEventListener('click', showNotificationModal); 
      btnNotifyCancel.addEventListener('click', handleNotificationCancel); // ä¿®æ­£: å‘¼å«æ–°å‡½å¼
      btnNotifySave.addEventListener('click', handleNotificationSave); 

      /** é é¢åˆ‡æ› */
      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          navTabs.forEach(t => t.classList.remove('active'));
          pages.forEach(p => p.classList.remove('active'));
          
          tab.classList.add('active');
          const pageId = tab.dataset.page;
          document.getElementById(pageId).classList.add('active');

          fab.style.display = (pageId === 'page-all') ? 'block' : 'none';
          
          if (pageId === 'page-manage-labels') renderLabelManagement();
          if (pageId === 'page-manage-presets') renderPresetManagementPage();
          if (pageId === 'page-settings') renderAllPages(); 
        });
      });
      
      /** è¨­ç½®é é¢æŒ‰éˆ• */
      toggleArchivedBtn.addEventListener('click', () => { showArchived = !showArchived; renderAllPage(); });
      btnClearArchived.addEventListener('click', () => {
          if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ‰€æœ‰å·²å°å­˜çš„æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
              events = events.filter(e => e.status !== 'Archived');
              saveData();
              renderAllPages();
          }
      });
      notifyTimeInput.addEventListener('change', (e) => { 
          config.notificationTime = e.target.value; 
          saveData(); 
      });
      btnTestNotification.addEventListener('click', handleTestNotification);

      // æ¨™ç±¤ç®¡ç†äº‹ä»¶
      btnManageLabels.addEventListener('click', () => navigateToPage('page-manage-labels'));
      btnAddLabel.addEventListener('click', () => {
          const newLabel = newLabelInput.value.trim();
          if (newLabel && !config.labels.includes(newLabel)) {
              config.labels.push(newLabel);
              saveData();
              newLabelInput.value = '';
              renderLabelManagement();
              renderAllPages();
          }
      });
      
      // é è¨­é›†ç®¡ç†äº‹ä»¶
      btnManagePresets.addEventListener('click', () => navigateToPage('page-manage-presets'));
      
      // è¿”å›æŒ‰éˆ•
      document.querySelectorAll('.btn-back').forEach(btn => {
          btn.addEventListener('click', (e) => navigateToPage(e.target.dataset.backTarget));
      });
      
      // å°èˆªå‡½æ•¸ (ç”¨æ–¼å­é é¢åˆ‡æ›)
      function navigateToPage(pageId) {
          navTabs.forEach(t => t.classList.remove('active'));
          pages.forEach(p => p.classList.remove('active'));
          document.getElementById(pageId).classList.add('active');
          fab.style.display = 'none';
          
          if (pageId === 'page-manage-labels') renderLabelManagement();
          if (pageId === 'page-manage-presets') renderPresetManagementPage();
      }

      // --- 8. PWA Service Worker è¨»å†Š ---
      function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js') 
              .then(registration => {
                console.log('ServiceWorker è¨»å†ŠæˆåŠŸ, scope: ', registration.scope);
              })
              .catch(err => {
                console.log('ServiceWorker è¨»å†Šå¤±æ•—: ', err);
              });
          });
        }
      }
      
      // --- 9. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• (Init) ---
      function init() {
        loadData(); // v1.3.1 é·ç§»é‚è¼¯
        checkAndArchiveEvents();
        renderAllPages();
        
        document.querySelector('.nav-tab[data-page="page-home"]').click(); 
        
        registerServiceWorker();
        
        requestNotificationPermission();
        checkAndSendNotifications();
      }

      // å•Ÿå‹•ï¼
      init();
    });
  </script>

</body>
</html>
