<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>æ—¥æœŸå€’æ•¸æ©Ÿ</title>
  
  <link rel="manifest" href="manifest.json">
  
  <link rel="stylesheet" href="css/style.css">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å€’æ•¸æ©Ÿ">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  
  <meta name="theme-color" content="#007aff">
</head>
<body>

  <div id="app-container">
    
    <main id="main-content">
      
      <section id="page-home" class="page active">
        <h1 class="page-title">é¦–é ç²¾é¸</h1>
        <div id="home-filter" class="filter-bar"></div>
        <div id="home-list"></div>
      </section>

      <section id="page-all" class="page">
        <h1 class="page-title">å…¨éƒ¨æ´»å‹•</h1>
        <div id="all-filter" class="filter-bar"></div>
        <button id="toggle-archived-btn" class="toggle-archived-btn"></button>
        <div id="all-list"></div>
      </section>

      <section id="page-settings" class="page">
        <h1 class="page-title">è¨­å®š</h1>
        
        <div class="settings-group">
          <div class="settings-item" id="btn-manage-labels">
            <span class="settings-item-label">æ¨™ç±¤ç®¡ç†</span>
            <span class="settings-item-value">â–¶</span>
          </div>
          <div class="settings-item" id="btn-manage-presets">
            <span class="settings-item-label">ç®¡ç†é è¨­æ´»å‹•é›†</span>
            <span class="settings-item-value">â–¶</span>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-item">
             <button>åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ (JSON)</button>
          </div>
          <div class="settings-item">
            <span class="settings-item-label">æ¸…ç†æ‰€æœ‰å·²å°å­˜</span>
             <button class="danger" id="btn-clear-archived">ç«‹å³æ¸…ç†</button>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-item">
            <span class="settings-item-label">ç‰ˆæœ¬è™Ÿ</span>
            <span class="settings-item-value">v1.2.0 (2025-11-02)</span>
          </div>
        </div>

      </section>
      
      <section id="page-manage-labels" class="page">
        <h1 class="page-title">æ¨™ç±¤ç®¡ç†</h1>
        <div id="labels-list"></div>
        <div class="form-group" style="padding-top: 16px;">
            <label>æ–°å¢æ¨™ç±¤</label>
            <input type="text" id="new-label-input" placeholder="æ¨™ç±¤åç¨±">
        </div>
        <div class="form-buttons">
            <button id="btn-add-label" class="form-btn btn-primary">æ–°å¢</button>
        </div>
        <div class="form-buttons" style="margin-top: 16px;">
            <button data-back-target="page-settings" class="form-btn btn-secondary btn-back">è¿”å›è¨­å®š</button>
        </div>
      </section>

      <section id="page-manage-presets" class="page">
        <h1 class="page-title">é è¨­é›†ç®¡ç†</h1>
        <p style="margin-bottom: 16px; color: var(--color-text-secondary);">
          é–‹å•Ÿé–‹é—œå¯å°‡é è¨­æ´»å‹•è¼‰å…¥åˆ°æ‚¨çš„ã€Œå…¨éƒ¨ã€é é¢ï¼Œä¸¦å¯éš¨æ™‚é—œé–‰éš±è—ã€‚
        </p>
        <div id="preset-management-list" class="settings-group">
            </div>
        <div class="form-buttons">
            <button data-back-target="page-settings" class="form-btn btn-secondary btn-back">è¿”å›è¨­å®š</button>
        </div>
      </section>
      
    </main>

    <button id="fab-add" class="fab" style="display: none;">+</button>

    <nav class="nav-bar">
      <button class="nav-tab active" data-page="page-home">
        <span class="icon">ğŸ </span>
        <span class="label">é¦–é </span>
      </button>
      <button class="nav-tab" data-page="page-all">
        <span class="icon">ğŸ“‹</span>
        <span class="label">å…¨éƒ¨</span>
      </button>
      <button class="nav-tab" data-page="page-settings">
        <span class="icon">âš™ï¸</span>
        <span class="label">è¨­å®š</span>
      </button>
    </nav>
  </div>

  <div id="modal-detail-view" class="modal-form" style="display: none;">
    <div id="modal-detail-content" class="form-content modal-detail-content">
      <h2 id="detail-title"></h2>
      <div id="event-detail-window">
        </div>
      <div class="detail-actions">
          <button id="btn-detail-close" class="form-btn btn-secondary">é—œé–‰</button>
          <button id="btn-detail-toggle-pin" class="form-btn btn-primary" data-pinned="false"></button>
          <button id="btn-detail-edit" class="form-btn btn-primary">ç·¨è¼¯</button>
      </div>
    </div>
  </div>


  <div id="modal-add-event" class="modal-form" style="display: none;">
    <div class="form-content modal-form-content">
      <h2 id="form-title">æ–°å¢æ´»å‹•</h2>
      <input type="hidden" id="event-id">
      <input type="hidden" id="event-preset-id"> <div class="form-group">
        <label for="event-title">æ¨™é¡Œ (å¿…å¡«)</label>
        <input type="text" id="event-title" placeholder="ä¾‹å¦‚ï¼šæœƒè€ƒå€’æ•¸">
      </div>
      
      <div class="form-group">
        <label for="event-date">ç›®æ¨™æ—¥æœŸ (å¿…å¡«)</label>
        <input type="date" id="event-date">
      </div>
      
      <div class="form-group">
        <label for="event-subtitle">å‰¯æ¨™é¡Œ (é¸å¡«)</label>
        <input type="text" id="event-subtitle" placeholder="ä¾‹å¦‚ï¼šæº–å‚™å‡†è€ƒè­‰">
      </div>
      
      <div class="form-group">
        <label for="event-labels">æ¨™ç±¤ (é¸å¡«ï¼Œç”¨é€—è™Ÿåˆ†éš”)</label>
        <input type="text" id="event-labels" placeholder="ä¾‹å¦‚ï¼šè€ƒè©¦, é‡è¦">
      </div>

      <div class="form-group">
        <label for="event-recurrence">é‡è¤‡é€±æœŸ (é¸å¡«)</label>
        <select id="event-recurrence">
          <option value="None">æ°¸ä¸</option>
          <option value="Yearly">æ¯å¹´</option>
          <option value="Monthly">æ¯æœˆ</option>
          <option value="Weekly">æ¯é€±</option>
        </select>
      </div>

      <div class="form-group">
        <label for="event-color">äº‹ä»¶é™°å½±é¡è‰² (é¸å¡«)</label>
        <input type="color" id="event-color" value="#007aff" style="width: 100px;">
      </div>

      <div class="form-group-inline">
        <label for="event-pinned">å®šé¸è‡³é¦–é </label>
        <input type="checkbox" id="event-pinned" class="form-toggle">
      </div>

      <div class="form-buttons">
        <button id="btn-form-cancel" class="form-btn btn-secondary">å–æ¶ˆ</button>
        <button id="btn-form-save" class="form-btn btn-primary">å„²å­˜</button>
      </div>
      
      <div class="form-buttons" style="margin-top: 0;">
         <button id="btn-form-delete" class="form-btn danger" style="width: 100%; display: none;">åˆªé™¤æ´»å‹•</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. ç‹€æ…‹èˆ‡å¸¸æ•¸ ---
      const STORAGE_KEY = 'countdownEvents_v1.2';
      const CONFIG_KEY = 'countdownConfig_v1.2';
      const DEFAULT_COLOR = '#007aff';
      
      let events = []; // ä¸»è³‡æ–™é™£åˆ—
      let config = {
          // é è¨­é›†é…ç½®ï¼š{ id: { name: '...', color: '...', isVisible: true/false } }
          presets: {}, 
          labels: ['è€ƒè©¦', 'å·¥ä½œ', 'ç”Ÿæ—¥', 'æ—…è¡Œ'], // è‡ªå®šç¾©æ¨™ç±¤
      }; 
      
      // ç¯©é¸å™¨æ”¹ç‚ºé™£åˆ— (æ”¯æ´å¤šé¸)
      let currentFilter = { home: ['å…¨éƒ¨'], all: ['å…¨éƒ¨'] }; 
      let showArchived = false;
      
      // å¯ç”¨çš„é è¨­é›†æ¸…å–® (è·¯å¾‘å¿…é ˆç›¸å°æ–¼ index.html)
      const availablePresets = [
        { id: 'holidays', name: 'åœ‹å®šç¯€æ—¥èˆ‡ç´€å¿µæ—¥', path: './assets/default_data/national_holidays.json' },
        { id: 'exams', name: 'å­¸ç§‘è€ƒè©¦', path: './assets/default_data/school_exams.json' },
      ];


      // --- 2. DOM å…ƒç´  ---
      const pages = document.querySelectorAll('.page');
      const navTabs = document.querySelectorAll('.nav-tab');
      const fab = document.getElementById('fab-add');
      
      const homeList = document.getElementById('home-list');
      const allList = document.getElementById('all-list');
      const homeFilter = document.getElementById('home-filter');
      const allFilter = document.getElementById('all-filter');
      const toggleArchivedBtn = document.getElementById('toggle-archived-btn');

      // Modals
      const modalDetail = document.getElementById('modal-detail-view');
      const detailTitle = document.getElementById('detail-title');
      const detailWindow = document.getElementById('event-detail-window');
      const btnDetailClose = document.getElementById('btn-detail-close');
      const btnDetailTogglePin = document.getElementById('btn-detail-toggle-pin');
      const btnDetailEdit = document.getElementById('btn-detail-edit');
      
      const modalForm = document.getElementById('modal-add-event');
      const formTitle = document.getElementById('form-title');
      const formEventId = document.getElementById('event-id');
      const formPresetId = document.getElementById('event-preset-id');
      const formTitleInput = document.getElementById('event-title');
      const formDateInput = document.getElementById('event-date');
      const formSubtitleInput = document.getElementById('event-subtitle');
      const formLabelsInput = document.getElementById('event-labels');
      const formRecurrenceInput = document.getElementById('event-recurrence');
      const formPinnedInput = document.getElementById('event-pinned');
      const formColorInput = document.getElementById('event-color');
      const btnFormCancel = document.getElementById('btn-form-cancel');
      const btnFormSave = document.getElementById('btn-form-save');
      const btnFormDelete = document.getElementById('btn-form-delete');
      
      // è¨­å®šé é¢
      const btnManageLabels = document.getElementById('btn-manage-labels');
      const btnManagePresets = document.getElementById('btn-manage-presets');
      const btnClearArchived = document.getElementById('btn-clear-archived');

      // æ¨™ç±¤ç®¡ç†å­é é¢
      const labelsList = document.getElementById('labels-list');
      const newLabelInput = document.getElementById('new-label-input');
      const btnAddLabel = document.getElementById('btn-add-label');
      
      // é è¨­é›†ç®¡ç†å­é é¢
      const presetManagementList = document.getElementById('preset-management-list');
      
      // --- 3. æ ¸å¿ƒé‚è¼¯ (æ—¥æœŸè¨ˆç®—èˆ‡è³‡æ–™) ---

      /** è¼‰å…¥è³‡æ–™ */
      function loadData() {
        const eventData = localStorage.getItem(STORAGE_KEY);
        const configData = localStorage.getItem(CONFIG_KEY);
        events = eventData ? JSON.parse(eventData) : [];
        
        if (configData) {
            // åˆä½µå„²å­˜çš„ configï¼Œç¢ºä¿æ–°åŠ å…¥çš„é è¨­ config çµæ§‹ä¹Ÿå­˜åœ¨
            const savedConfig = JSON.parse(configData);
            config = { ...config, ...savedConfig };
            // ç¢ºä¿ presets çµæ§‹å®Œæ•´
            if (!config.presets) config.presets = {}; 
        }
      }

      /** å„²å­˜è³‡æ–™ */
      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
      }

      /** ç”¢ç”Ÿå”¯ä¸€ ID */
      function generateID() {
        return 'id_' + Math.random().toString(36).substr(2, 9);
      }
      
      /** æª¢æŸ¥ä¸¦è‡ªå‹•å°å­˜éæœŸæ´»å‹• */
      function checkAndArchiveEvents() {
        let needsSave = false;
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        
        events.forEach(event => {
          if (event.status !== 'Active') return;
          
          const targetDate = new Date(event.date + 'T00:00:00');
          const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

          if (diffDays < 0) { // å·²éæœŸ
            
            // è™•ç†é€±æœŸæ€§
            if (event.recurrence !== 'None') {
              let newDate = targetDate;
              // å¾ªç’°æ¨é€²åˆ°æœªä¾†
              while (newDate < today) {
                if (event.recurrence === 'Yearly') {
                  newDate.setFullYear(newDate.getFullYear() + 1);
                } else if (event.recurrence === 'Monthly') {
                  newDate.setMonth(newDate.getMonth() + 1);
                } else if (event.recurrence === 'Weekly') {
                  newDate.setDate(newDate.getDate() + 7);
                } else {
                    break; // ç„¡æ•ˆé€±æœŸå‰‡è·³å‡º
                }
              }
              event.date = newDate.toISOString().split('T')[0];
              needsSave = true;
            } else {
              // æ°¸ä¹…éæœŸ -> å°å­˜
              event.status = 'Archived';
              event.is_pinned = false;
              needsSave = true;
            }
          }
        });

        if (needsSave) saveData();
      }

      /** è¨ˆç®—å€’æ•¸å¤©æ•¸ */
      function calculateCountdown(dateStr) {
        const targetDate = new Date(dateStr + 'T00:00:00');
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        const diffDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

        if (diffDays === 0) return { days: 'ä»Š', unit: 'å¤©', status: 'today' };
        if (diffDays < 0) return { days: Math.abs(diffDays), unit: 'å¤©å‰', status: 'expired' };
        return { days: diffDays, unit: 'å¤©', status: 'pending' };
      }


      // --- 4. æ¸²æŸ“é‚è¼¯ (UI) ---

      /** å–å¾—äº‹ä»¶çš„é¡è‰² */
      function getEventColor(event) {
          if (event.color) return event.color;
          if (event.presetId && config.presets[event.presetId] && config.presets[event.presetId].color) {
              return config.presets[event.presetId].color;
          }
          return DEFAULT_COLOR; 
      }

      /** ç”¢ç”Ÿå–®å€‹å¡ç‰‡çš„ HTML */
      function createEventCardHTML(event) {
        const countdown = calculateCountdown(event.date);
        const eventColor = getEventColor(event);
        
        const labelsHTML = (event.labels || [])
          .map(label => `<span class="card-label">${label}</span>`)
          .join('');
        
        let countdownHTML;
        if (event.status === 'Archived') {
          countdownHTML = `<span class="countdown-expired">å·²å°å­˜</span>`;
        } else if (countdown.status === 'expired') {
            countdownHTML = `<div class="countdown-days">${countdown.days}</div><div class="countdown-unit">${countdown.unit}</div>`;
        } else {
           countdownHTML = `<div class="countdown-days">${countdown.days}</div><div class="countdown-unit">${countdown.unit}</div>`;
        }

        return `
          <div 
            class="event-card ${event.status === 'Archived' ? 'archived' : ''}" 
            data-id="${event.id}"
            style="--shadow-color: ${eventColor};"
          >
            <div class="card-details">
              ${labelsHTML ? `<div class="card-labels">${labelsHTML}</div>` : ''}
              <div class="card-title">${event.title}</div>
              ${event.subtitle ? `<div class="card-subtitle">${event.subtitle}</div>` : ''}
              <div class="card-date">${event.date}</div>
            </div>
            <div class="card-countdown">
              ${countdownHTML}
            </div>
          </div>
        `;
      }
      
      /** æ¸²æŸ“ç¯©é¸å™¨ (æ”¯æ´å¤šé¸) */
      function renderFilterBar(page, container) {
          const isHome = page === 'home';
          const current = currentFilter[page]; // ç¾åœ¨æ˜¯é™£åˆ—
          
          // å–å¾—æ‰€æœ‰å¯ç”¨æ¨™ç±¤ (åƒ…é™ç•¶å‰é é¢åˆ—è¡¨ä¸­çš„æ´»å‹•æ¨™ç±¤)
          const allLabels = events
            .filter(e => isHome ? e.is_pinned && e.status === 'Active' : e.status === 'Active') // ç¯©é¸å™¨åªçœ‹ Active çš„
            .reduce((acc, e) => {
                (e.labels || []).forEach(label => acc.add(label));
                return acc;
            }, new Set());

          const availableLabels = ['å…¨éƒ¨', ...Array.from(allLabels)].sort();
          
          container.innerHTML = availableLabels.map(label => `
              <div 
                  class="filter-chip ${current.includes(label) ? 'selected' : ''}" 
                  data-label="${label}"
                  data-page="${page}"
              >
                  ${label}
              </div>
          `).join('');
      }

      /** å–å¾—éæ¿¾å¾Œçš„æ´»å‹• */
      function getFilteredEvents(page) {
        const isHome = page === 'home';
        const filterLabels = currentFilter[page];
        const statusToShow = (page === 'all' && showArchived) ? 'Archived' : 'Active';

        let filtered = events
          // 1. åŸºç¤éæ¿¾ (å®šé¸/ç‹€æ…‹)
          .filter(e => {
            if (isHome) {
              return e.is_pinned && e.status === 'Active';
            }
            return e.status === statusToShow;
          })
          // 2. é è¨­é›†å¯è¦‹æ€§éæ¿¾
          .filter(e => {
            if (e.presetId && config.presets[e.presetId]) {
              return config.presets[e.presetId].isVisible;
            }
            return true; // éé è¨­é›†æ´»å‹•æ°¸é å¯è¦‹
          });

        // 3. æ¨™ç±¤éæ¿¾ (å¤šé¸)
        if (!filterLabels.includes('å…¨éƒ¨')) {
          filtered = filtered.filter(e => {
            if (!e.labels || e.labels.length === 0) return false;
            // æª¢æŸ¥ e.labels ä¸­æ˜¯å¦è‡³å°‘æœ‰ä¸€å€‹æ¨™ç±¤å­˜åœ¨æ–¼ filterLabels ä¸­
            return e.labels.some(label => filterLabels.includes(label));
          });
        }
        
        // 4. æ’åº
        return filtered.sort((a, b) => new Date(a.date) - new Date(b.date));
      }


      /** æ¸²æŸ“é¦–é  */
      function renderHomePage() {
        renderFilterBar('home', homeFilter);
        const filteredEvents = getFilteredEvents('home');

        if (filteredEvents.length === 0) {
          homeList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“Œ</div><p>å°šç„¡å®šé¸æ´»å‹•æˆ–ç¯©é¸çµæœç‚ºç©º</p><p>è«‹è‡³ã€Œå…¨éƒ¨ã€é é¢æ–°å¢æˆ–å®šé¸æ´»å‹•</p></div>`;
        } else {
          homeList.innerHTML = filteredEvents.map(createEventCardHTML).join('');
        }
      }

      /** æ¸²æŸ“å…¨éƒ¨é é¢ */
      function renderAllPage() {
        renderFilterBar('all', allFilter);
        const filteredEvents = getFilteredEvents('all');

        if (filteredEvents.length === 0) {
          allList.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${showArchived ? 'ğŸ—„ï¸' : 'ğŸ‰'}</div><p>${showArchived ? 'å°å­˜å€æ˜¯ç©ºçš„' : 'ç›®å‰æ²’æœ‰æ´»å‹•æˆ–ç¯©é¸çµæœç‚ºç©º'}</p>${!showArchived ? '<p>é»æ“Šå³ä¸‹è§’ + é–‹å§‹æ–°å¢</p>' : ''}</div>`;
        } else {
          allList.innerHTML = filteredEvents.map(createEventCardHTML).join('');
        }
        
        const archivedCount = events.filter(e => e.status === 'Archived').length;
        toggleArchivedBtn.textContent = `${showArchived ? 'éš±è—' : 'é¡¯ç¤º'}å·²å°å­˜ (${archivedCount})`;
      }
      
      /** æ¸²æŸ“æ¨™ç±¤ç®¡ç†é é¢ */
      function renderLabelManagement() {
          labelsList.innerHTML = (config.labels || []).map(label => `
              <div class="settings-item">
                  <span class="settings-item-label">${label}</span>
                  <button data-label="${label}" class="danger" style="width: auto;">åˆªé™¤</button>
              </div>
          `).join('');
          
          labelsList.querySelectorAll('button.danger').forEach(btn => {
              btn.addEventListener('click', (e) => {
                  const labelToDelete = e.target.dataset.label;
                  if (confirm(`ç¢ºå®šè¦åˆªé™¤æ¨™ç±¤ "${labelToDelete}" å—ï¼Ÿ`)) {
                      config.labels = config.labels.filter(l => l !== labelToDelete);
                      saveData();
                      renderLabelManagement();
                      renderAllPages(); 
                  }
              });
          });
      }
      
      /** æ¸²æŸ“é è¨­é›†ç®¡ç†é é¢ (æ–°) */
      function renderPresetManagementPage() {
          presetManagementList.innerHTML = availablePresets.map(preset => {
              const presetConfig = config.presets[preset.id] || {};
              const isVisible = presetConfig.isVisible || false; // é è¨­ç‚ºæœªè¼‰å…¥ (ä¸å¯è¦‹)
              const color = presetConfig.color || DEFAULT_COLOR;

              return `
                  <div class="preset-item" data-id="${preset.id}">
                      <span class="preset-name">${preset.name}</span>
                      <div class="preset-controls">
                          <input type="color" value="${color}" class="preset-color-picker" data-id="${preset.id}" ${!isVisible ? 'disabled' : ''}>
                          <input type="checkbox" ${isVisible ? 'checked' : ''} class="form-toggle preset-toggle" data-id="${preset.id}">
                      </div>
                  </div>
              `;
          }).join('');
          
          // ç¶å®šäº‹ä»¶
          presetManagementList.querySelectorAll('.preset-color-picker').forEach(input => {
              input.addEventListener('change', (e) => {
                  const presetId = e.target.dataset.id;
                  config.presets[presetId].color = e.target.value;
                  saveData();
                  renderAllPages(); // é¡è‰²æ”¹è®Šï¼Œéœ€è¦é‡ç¹ªå¡ç‰‡
              });
          });

          presetManagementList.querySelectorAll('.preset-toggle').forEach(toggle => {
              toggle.addEventListener('click', (e) => {
                  const presetId = e.target.dataset.id;
                  const isVisible = e.target.checked;
                  handlePresetToggle(presetId, isVisible);
                  // åˆ‡æ›æ™‚ï¼Œå•Ÿç”¨/ç¦ç”¨é¡è‰²é¸æ“‡å™¨
                  e.target.closest('.preset-item').querySelector('.preset-color-picker').disabled = !isVisible;
              });
          });
      }

      /** æ¸²æŸ“æ‰€æœ‰é é¢ (ä¸»å‡½æ•¸) */
      function renderAllPages() {
        renderHomePage();
        renderAllPage();
      }


      // --- 5. æ¨¡æ…‹è¦–çª—èˆ‡è¡¨å–®é‚è¼¯ ---
      
      let currentEventId = null;

      /** é¡¯ç¤ºè©³ç´°è³‡æ–™è¦–çª— */
      function showDetailModal(event) {
          currentEventId = event.id;
          detailTitle.textContent = event.title;
          btnDetailTogglePin.textContent = event.is_pinned ? 'å–æ¶ˆå®šé¸' : 'å®šé¸åˆ°é¦–é ';
          btnDetailTogglePin.dataset.pinned = event.is_pinned;

          const eventColor = getEventColor(event);
          
          // å…§å®¹
          const content = `
              <div class="detail-item">
                  <span class="detail-item-label">å€’æ•¸</span>
                  <span class="detail-item-value">${calculateCountdown(event.date).days} ${calculateCountdown(event.date).unit}</span>
              </div>
              <div class="detail-item">
                  <span class="detail-item-label">ç›®æ¨™æ—¥æœŸ</span>
                  <span class="detail-item-value">${event.date}</span>
              </div>
              ${event.subtitle ? `<div class="detail-item"><span class="detail-item-label">å‰¯æ¨™é¡Œ</span><span class="detail-item-value">${event.subtitle}</span></div>` : ''}
              ${(event.labels && event.labels.length > 0) ? `<div class="detail-item"><span class="detail-item-label">æ¨™ç±¤</span><span class="detail-item-value">${event.labels.join(', ')}</span></div>` : ''}
              ${event.recurrence !== 'None' ? `<div class="detail-item"><span class="detail-item-label">é‡è¤‡é€±æœŸ</span><span class="detail-item-value">${event.recurrence}</span></div>` : ''}
              ${event.presetId ? `<div class="detail-item"><span class="detail-item-label">æ‰€å±¬é è¨­é›†</span><span class="detail-item-value">${config.presets[event.presetId]?.name || 'æœªçŸ¥'}</span></div>` : ''}
              <div class="detail-item">
                  <span class="detail-item-label">ç‹€æ…‹</span>
                  <span class="detail-item-value">${event.status === 'Active' ? 'æ´»å‹•ä¸­' : 'å·²å°å­˜'}</span>
              </div>
              <div class="detail-item">
                  <span class="detail-item-label">é™°å½±é¡è‰²</span>
                  <span class="detail-item-value" style="color: ${eventColor};">${eventColor}</span>
              </div>
          `;
          detailWindow.innerHTML = content;
          modalDetail.style.display = 'flex';
      }

      /** é¡¯ç¤ºæ–°å¢/ç·¨è¼¯è¦–çª— */
      function showFormModal(event = null) {
        if (event) {
          // ç·¨è¼¯æ¨¡å¼
          formTitle.textContent = 'ç·¨è¼¯æ´»å‹•';
          formEventId.value = event.id;
          formPresetId.value = event.presetId || '';
          formTitleInput.value = event.title;
          formDateInput.value = event.date;
          formSubtitleInput.value = event.subtitle || '';
          formLabelsInput.value = (event.labels || []).join(', ');
          formRecurrenceInput.value = event.recurrence || 'None';
          formPinnedInput.checked = event.is_pinned;
          formColorInput.value = event.color || getEventColor(event);
          btnFormDelete.style.display = 'block';

          // é è¨­é›†å°å…¥çš„æ´»å‹•ï¼Œæ¨™é¡Œ/æ—¥æœŸ/é€±æœŸé–å®š
          const isPresetEvent = !!event.presetId;
          formTitleInput.disabled = isPresetEvent;
          formDateInput.disabled = isPresetEvent;
          formRecurrenceInput.disabled = isPresetEvent;
          formColorInput.disabled = isPresetEvent; // é¡è‰²ç”±é è¨­é›†ç®¡ç†
          
        } else {
          // æ–°å¢æ¨¡å¼
          formTitle.textContent = 'æ–°å¢æ´»å‹•';
          formEventId.value = '';
          formPresetId.value = '';
          formTitleInput.value = '';
          formDateInput.value = '';
          formSubtitleInput.value = '';
          formLabelsInput.value = ''; // æ–°å¢æ™‚é è¨­ç‚ºç©º
          formRecurrenceInput.value = 'None';
          formPinnedInput.checked = false;
          formColorInput.value = DEFAULT_COLOR;
          btnFormDelete.style.display = 'none';
          
          formTitleInput.disabled = false;
          formDateInput.disabled = false;
          formRecurrenceInput.disabled = false;
          formColorInput.disabled = false;
        }
        hideDetailModal(); // ç¢ºä¿ä¸æœƒåŒæ™‚é–‹å•Ÿ
        modalForm.style.display = 'flex';
      }
      
      function hideDetailModal() { modalDetail.style.display = 'none'; currentEventId = null; }
      function hideFormModal() { modalForm.style.display = 'none'; }

      /** åˆªé™¤æ´»å‹• */
      function handleDelete() {
        const id = formEventId.value;
        if (!id) return;

        if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
          events = events.filter(e => e.id !== id);
          saveData();
          renderAllPages();
          hideFormModal();
        }
      }
      
      function handleFormSubmit() {
        const id = formEventId.value;
        const title = formTitleInput.value.trim();
        const date = formDateInput.value;

        if (!title || !date) {
          alert('è«‹è¼¸å…¥æ¨™é¡Œå’Œæ—¥æœŸï¼');
          return;
        }
        
        const labels = formLabelsInput.value.split(',').map(s => s.trim()).filter(Boolean);

        const eventData = {
          id: id || generateID(),
          title: title,
          subtitle: formSubtitleInput.value.trim() || '',
          date: date,
          labels: labels,
          recurrence: formRecurrenceInput.value,
          is_pinned: formPinnedInput.checked,
          color: formColorInput.value !== DEFAULT_COLOR ? formColorInput.value : undefined,
          presetId: formPresetId.value || undefined, 
          status: 'Active' 
        };
        
        // å¦‚æœæ˜¯é è¨­é›†äº‹ä»¶ï¼Œå‰‡åªæ›´æ–°å¯ä¿®æ”¹æ¬„ä½
        if (eventData.presetId) {
            const originalEvent = events.find(e => e.id === id);
            if(originalEvent) {
                eventData.title = originalEvent.title;
                eventData.date = originalEvent.date;
                eventData.recurrence = originalEvent.recurrence;
                eventData.color = originalEvent.color; 
                eventData.subtitle = formSubtitleInput.value.trim() || ''; 
                eventData.labels = labels;
                eventData.is_pinned = formPinnedInput.checked;
            }
        }

        if (id) {
          const index = events.findIndex(e => e.id === id);
          if (index > -1) {
            events[index] = { ...events[index], ...eventData };
          }
        } else {
          events.push(eventData);
        }

        saveData();
        renderAllPages();
        hideFormModal();
      }
      
      /** è™•ç†é è¨­é›†é¡¯ç¤º/éš±è—åˆ‡æ› (æ–°) */
      async function handlePresetToggle(presetId, isVisible) {
          const preset = availablePresets.find(p => p.id === presetId);
          if (!preset) return;

          // 1. æ›´æ–° Config ç‹€æ…‹
          if (!config.presets[presetId]) {
              config.presets[presetId] = { name: preset.name, color: DEFAULT_COLOR, isVisible: false };
          }
          config.presets[presetId].isVisible = isVisible;
          
          let needsDataFetch = false;
          
          // 2. æª¢æŸ¥æ˜¯å¦éœ€è¦è¼‰å…¥è³‡æ–™
          // å¦‚æœåˆ‡æ›ç‚º "é–‹å•Ÿ" ä¸”è³‡æ–™å°šæœªè¼‰å…¥ (ä»¥ presetId æª¢æŸ¥ events)
          if (isVisible && !events.some(e => e.presetId === presetId)) {
              needsDataFetch = true;
          }

          if (needsDataFetch) {
              console.log(`Fetching preset: ${preset.name}`);
              try {
                  const response = await fetch(preset.path); // ä½¿ç”¨ç›¸å°è·¯å¾‘
                  if (!response.ok) throw new Error(`ç„¡æ³•è¼‰å…¥ ${preset.name}`);
                  
                  const defaultEvents = await response.json();
                  
                  defaultEvents.forEach(event => {
                      if (!events.some(e => e.title === event.title && e.presetId === preset.id)) {
                          events.push({
                              ...event,
                              id: generateID(),
                              status: 'Active',
                              presetId: preset.id,
                          });
                      }
                  });
                  checkAndArchiveEvents(); // å°å…¥å¾Œç«‹å³æª¢æŸ¥
                  
              } catch (error) {
                  console.error('å°å…¥å¤±æ•—:', error);
                  alert(`å°å…¥é è¨­é›† ${preset.name} å¤±æ•—ã€‚`);
                  // å°å…¥å¤±æ•—ï¼Œæ¢å¾©åˆ‡æ›
                  config.presets[presetId].isVisible = false;
                  e.target.checked = false; 
              }
          }

          // 3. å„²å­˜ä¸¦é‡ç¹ª
          saveData();
          renderAllPages();
      }

      // --- 6. äº‹ä»¶ç›£è½å™¨ ---

      /** ç¯©é¸å™¨äº‹ä»¶å§”æ´¾ (å¤šé¸) */
      document.getElementById('main-content').addEventListener('click', (e) => {
          if (e.target.classList.contains('filter-chip')) {
              const page = e.target.dataset.page;
              const label = e.target.dataset.label;
              
              let current = currentFilter[page]; // [ 'å…¨éƒ¨' ]

              if (label === 'å…¨éƒ¨') {
                  current = ['å…¨éƒ¨'];
              } else {
                  // å¦‚æœ "å…¨éƒ¨" åœ¨è£¡é¢ï¼Œå…ˆç§»é™¤
                  const allIndex = current.indexOf('å…¨éƒ¨');
                  if (allIndex > -1) {
                      current.splice(allIndex, 1);
                  }
                  
                  // æª¢æŸ¥æ¨™ç±¤æ˜¯å¦å·²å­˜åœ¨
                  const labelIndex = current.indexOf(label);
                  if (labelIndex > -1) {
                      // å­˜åœ¨ -> ç§»é™¤
                      current.splice(labelIndex, 1);
                  } else {
                      // ä¸å­˜åœ¨ -> åŠ å…¥
                      current.push(label);
                  }
                  
                  // å¦‚æœé™£åˆ—ç©ºäº†ï¼Œæ”¹å› "å…¨éƒ¨"
                  if (current.length === 0) {
                      current = ['å…¨éƒ¨'];
                  }
              }
              
              currentFilter[page] = current;
              
              if (page === 'home') renderHomePage();
              if (page === 'all') renderAllPage();
          }
          
          // å¡ç‰‡é»æ“Š -> é¡¯ç¤ºè©³ç´°è³‡æ–™
          const card = e.target.closest('.event-card');
          if (card) {
              const id = card.dataset.id;
              const event = events.find(e => e.id === id);
              if (event) showDetailModal(event);
          }
      });

      /** æ¨¡æ…‹è¦–çª—æ“ä½œ */
      btnDetailClose.addEventListener('click', hideDetailModal);
      btnDetailEdit.addEventListener('click', () => {
          const event = events.find(e => e.id === currentEventId);
          if (event) showFormModal(event);
      });
      btnDetailTogglePin.addEventListener('click', () => {
          const event = events.find(e => e.id === currentEventId);
          if (event) {
              event.is_pinned = !event.is_pinned;
              saveData();
              renderAllPages();
              hideDetailModal();
          }
      });
      
      btnFormCancel.addEventListener('click', hideFormModal);
      btnFormSave.addEventListener('click', handleFormSubmit);
      btnFormDelete.addEventListener('click', handleDelete);
      fab.addEventListener('click', () => showFormModal(null));
      
      /** é é¢åˆ‡æ› */
      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          navTabs.forEach(t => t.classList.remove('active'));
          pages.forEach(p => p.classList.remove('active'));
          
          tab.classList.add('active');
          const pageId = tab.dataset.page;
          document.getElementById(pageId).classList.add('active');

          fab.style.display = (pageId === 'page-all') ? 'block' : 'none';
          
          // é€²å…¥è¨­å®šå­é é¢çš„æ¸²æŸ“
          if (pageId === 'page-manage-labels') renderLabelManagement();
          if (pageId === 'page-manage-presets') renderPresetManagementPage();
          if (pageId === 'page-settings') renderAllPages(); 
        });
      });
      
      /** è¨­ç½®é é¢æŒ‰éˆ• */
      toggleArchivedBtn.addEventListener('click', () => { showArchived = !showArchived; renderAllPage(); });
      btnClearArchived.addEventListener('click', () => {
          if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ‰€æœ‰å·²å°å­˜çš„æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
              events = events.filter(e => e.status !== 'Archived');
              saveData();
              renderAllPages();
          }
      });

      // æ¨™ç±¤ç®¡ç†äº‹ä»¶
      btnManageLabels.addEventListener('click', () => navigateToPage('page-manage-labels'));
      btnAddLabel.addEventListener('click', () => {
          const newLabel = newLabelInput.value.trim();
          if (newLabel && !config.labels.includes(newLabel)) {
              config.labels.push(newLabel);
              saveData();
              newLabelInput.value = '';
              renderLabelManagement();
              renderAllPages();
          }
      });
      
      // é è¨­é›†ç®¡ç†äº‹ä»¶ (æ–°)
      btnManagePresets.addEventListener('click', () => navigateToPage('page-manage-presets'));
      
      // è¿”å›æŒ‰éˆ•
      document.querySelectorAll('.btn-back').forEach(btn => {
          btn.addEventListener('click', (e) => navigateToPage(e.target.dataset.backTarget));
      });
      
      // å°èˆªå‡½æ•¸ (ç”¨æ–¼å­é é¢åˆ‡æ›)
      function navigateToPage(pageId) {
          navTabs.forEach(t => t.classList.remove('active'));
          pages.forEach(p => p.classList.remove('active'));
          document.getElementById(pageId).classList.add('active');
          fab.style.display = 'none';
          
          if (pageId === 'page-manage-labels') renderLabelManagement();
          if (pageId === 'page-manage-presets') renderPresetManagementPage();
      }

      // --- 7. PWA Service Worker è¨»å†Š (ä¿®æ­£) ---
      function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            // *** é—œéµä¿®æ­£: æ”¹ç‚ºä½¿ç”¨ç›¸å°è·¯å¾‘ "./sw.js" ***
            // è§£æ±ºäº† /sw.js çš„ 404 éŒ¯èª¤
            navigator.serviceWorker.register('./sw.js') 
              .then(registration => {
                console.log('ServiceWorker è¨»å†ŠæˆåŠŸ, scope: ', registration.scope);
              })
              .catch(err => {
                console.log('ServiceWorker è¨»å†Šå¤±æ•—: ', err);
              });
          });
        }
      }
      
      // --- 8. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• (Init) ---
      function init() {
        loadData();
        checkAndArchiveEvents();
        renderAllPages();
        
        // ç¢ºä¿åˆå§‹é é¢æ˜¯é¦–é 
        document.querySelector('.nav-tab[data-page="page-home"]').click(); 
        
        registerServiceWorker();
      }

      // å•Ÿå‹•ï¼
      init();
    });
  </script>

</body>
</html>
