<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>æ—¥æœŸå€’æ•¸æ©Ÿ</title>
  
  <link rel="manifest" href="manifest.json">
  
  <link rel="stylesheet" href="css/style.css">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å€’æ•¸æ©Ÿ">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  
  <meta name="theme-color" content="#007aff">
</head>
<body>

  <div id="app-container">
    
    <main id="main-content">
      
      <section id="page-home" class="page active">
        <h1 class="page-title">é¦–é ç²¾é¸</h1>
        <div id="home-list">
          </div>
      </section>

      <section id="page-all" class="page">
        <h1 class="page-title">å…¨éƒ¨æ´»å‹•</h1>
        <button id="toggle-archived-btn" class="toggle-archived-btn">é¡¯ç¤ºå·²å°å­˜ (0)</button>
        <div id="all-list">
          </div>
      </section>

      <section id="page-settings" class="page">
        <h1 class="page-title">è¨­å®š</h1>
        
        <div class="settings-group">
          <div class="settings-item">
            <span class="settings-item-label">æ¨™ç±¤ç®¡ç†</span>
            <span class="settings-item-value">â–¶</span>
          </div>
          <div class="settings-item" id="btn-import-defaults">
             <button>å°å…¥é è¨­æ´»å‹•é›†</button>
          </div>
          <div class="settings-item">
             <button>åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ (JSON)</button>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-item">
            <span class="settings-item-label">æ¸…ç†æ‰€æœ‰å·²å°å­˜</span>
             <button class="danger" id="btn-clear-archived">ç«‹å³æ¸…ç†</button>
          </div>
        </div>

        <div class="settings-group">
          <div class="settings-item">
            <span class="settings-item-label">ç‰ˆæœ¬è™Ÿ</span>
            <span class="settings-item-value">v1.0.0 (2025-10-29)</span>
          </div>
        </div>

      </section>
      
    </main>

    <button id="fab-add" class="fab" style="display: none;">+</button>

    <nav class="nav-bar">
      <button class="nav-tab active" data-page="page-home">
        <span class="icon">ğŸ </span>
        <span class="label">é¦–é </span>
      </button>
      <button class="nav-tab" data-page="page-all">
        <span class="icon">ğŸ“‹</span>
        <span class="label">å…¨éƒ¨</span>
      </button>
      <button class="nav-tab" data-page="page-settings">
        <span class="icon">âš™ï¸</span>
        <span class="label">è¨­å®š</span>
      </button>
    </nav>
  </div>

  <div id="modal-add-event" class="modal-form" style="display: none;">
    <div class="form-content">
      <h2 id="form-title">æ–°å¢æ´»å‹•</h2>
      <input type="hidden" id="event-id">
      
      <div class="form-group">
        <label for="event-title">æ¨™é¡Œ (å¿…å¡«)</label>
        <input type="text" id="event-title" placeholder="ä¾‹å¦‚ï¼šæœƒè€ƒå€’æ•¸">
      </div>
      
      <div class="form-group">
        <label for="event-date">ç›®æ¨™æ—¥æœŸ (å¿…å¡«)</label>
        <input type="date" id="event-date">
      </div>
      
      <div class="form-group">
        <label for="event-subtitle">å‰¯æ¨™é¡Œ (é¸å¡«)</label>
        <input type="text" id="event-subtitle" placeholder="ä¾‹å¦‚ï¼šæº–å‚™å‡†è€ƒè­‰">
      </div>
      
      <div class="form-group">
        <label for="event-labels">æ¨™ç±¤ (é¸å¡«ï¼Œç”¨é€—è™Ÿåˆ†éš”)</label>
        <input type="text" id="event-labels" placeholder="ä¾‹å¦‚ï¼šè€ƒè©¦, é‡è¦">
      </div>

      <div class="form-group">
        <label for="event-recurrence">é‡è¤‡é€±æœŸ (é¸å¡«)</label>
        <select id="event-recurrence">
          <option value="None">æ°¸ä¸</option>
          <option value="Yearly">æ¯å¹´</option>
          <option value="Monthly">æ¯æœˆ</option>
          <option value="Weekly">æ¯é€±</option>
        </select>
      </div>

      <div class="form-group-inline">
        <label for="event-pinned">å®šé¸è‡³é¦–é </label>
        <input type="checkbox" id="event-pinned" class="form-toggle">
      </div>

      <div class="form-buttons">
        <button id="btn-cancel" class="form-btn btn-secondary">å–æ¶ˆ</button>
        <button id="btn-save" class="form-btn btn-primary">å„²å­˜</button>
      </div>
      
      <div class="form-buttons" style="margin-top: 0;">
         <button id="btn-delete" class="form-btn danger" style="width: 100%; display: none;">åˆªé™¤æ´»å‹•</button>
      </div>
    </div>
  </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // --- 1. ç‹€æ…‹èˆ‡å¸¸æ•¸ ---
      const STORAGE_KEY = 'countdownEvents_v1';
      let events = []; // ä¸»è³‡æ–™é™£åˆ—
      let showArchived = false; // "å…¨éƒ¨" é é¢æ˜¯å¦é¡¯ç¤ºå·²å°å­˜
      const today = new Date();
      today.setHours(0, 0, 0, 0); // æ¨™æº–åŒ– "ä»Šå¤©" çš„é–‹å§‹

      // --- 2. DOM å…ƒç´  ---
      const pages = document.querySelectorAll('.page');
      const navTabs = document.querySelectorAll('.nav-tab');
      const fab = document.getElementById('fab-add');
      
      const homeList = document.getElementById('home-list');
      const allList = document.getElementById('all-list');
      const toggleArchivedBtn = document.getElementById('toggle-archived-btn');

      // è¡¨å–® Modal
      const modal = document.getElementById('modal-add-event');
      const formTitle = document.getElementById('form-title');
      const formEventId = document.getElementById('event-id');
      const formTitleInput = document.getElementById('event-title');
      const formDateInput = document.getElementById('event-date');
      const formSubtitleInput = document.getElementById('event-subtitle');
      const formLabelsInput = document.getElementById('event-labels');
      const formRecurrenceInput = document.getElementById('event-recurrence');
      const formPinnedInput = document.getElementById('event-pinned');
      const btnCancel = document.getElementById('btn-cancel');
      const btnSave = document.getElementById('btn-save');
      const btnDelete = document.getElementById('btn-delete');
      const btnClearArchived = document.getElementById('btn-clear-archived');
      const btnImportDefaults = document.getElementById('btn-import-defaults');

      
      // --- 3. æ ¸å¿ƒé‚è¼¯ (æ—¥æœŸè¨ˆç®—èˆ‡è³‡æ–™) ---

      /** è¼‰å…¥è³‡æ–™ */
      function loadData() {
        const data = localStorage.getItem(STORAGE_KEY);
        events = data ? JSON.parse(data) : [];
      }

      /** å„²å­˜è³‡æ–™ */
      function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
      }

      /** ç”¢ç”Ÿå”¯ä¸€ ID */
      function generateID() {
        return '_' + Math.random().toString(36).substr(2, 9);
      }

      /**
       * è¨ˆç®—å€’æ•¸å¤©æ•¸
       * @param {string} dateStr - æ—¥æœŸå­—ä¸² (YYYY-MM-DD)
       * @returns {object} { days: number, unit: string, status: 'pending'|'today'|'expired' }
       */
      function calculateCountdown(dateStr) {
        // ç¢ºä¿æ—¥æœŸè¢«è§£æç‚ºæœ¬åœ°æ™‚å€çš„åˆå¤œ
        const targetDate = new Date(dateStr + 'T00:00:00');
        
        const diffTime = targetDate - today;
        // å‘ä¸Šå–æ•´ï¼Œç¢ºä¿ 23:59 ä¹Ÿæ˜¯ 1 å¤©
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
          return { days: 'ä»Š', unit: 'å¤©', status: 'today' };
        } else if (diffDays < 0) {
          return { days: Math.abs(diffDays), unit: 'å¤©å‰', status: 'expired' };
        } else {
          return { days: diffDays, unit: 'å¤©', status: 'pending' };
        }
      }

      /** æª¢æŸ¥ä¸¦è‡ªå‹•å°å­˜éæœŸæ´»å‹• (æ ¸å¿ƒï¼) */
      function checkAndArchiveEvents() {
        let needsSave = false;
        
        events.forEach(event => {
          if (event.status !== 'Active') return; // åªè™•ç†æ´»å‹•ä¸­

          const countdown = calculateCountdown(event.date);

          if (countdown.status === 'expired') {
            // æª¢æŸ¥é€±æœŸæ€§
            if (event.recurrence === 'None') {
              // 1. æ°¸ä¹…éæœŸ -> å°å­˜
              event.status = 'Archived';
              event.is_pinned = false; // è‡ªå‹•å–æ¶ˆå®šé¸
              console.log(`Archiving: ${event.title}`);
              needsSave = true;
            } else {
              // 2. é€±æœŸæ€§æ´»å‹• -> æ›´æ–°æ—¥æœŸ
              let newDate = new Date(event.date + 'T00:00:00');
              while (newDate <= today) { // ç¢ºä¿æ–°æ—¥æœŸåœ¨æœªä¾†
                if (event.recurrence === 'Yearly') {
                  newDate.setFullYear(newDate.getFullYear() + 1);
                } else if (event.recurrence === 'Monthly') {
                  newDate.setMonth(newDate.getMonth() + 1);
                } else if (event.recurrence === 'Weekly') {
                  newDate.setDate(newDate.getDate() + 7);
                }
              }
              event.date = newDate.toISOString().split('T')[0];
              console.log(`Recycling: ${event.title} to ${event.date}`);
              needsSave = true;
            }
          }
        });

        if (needsSave) {
          saveData();
        }
      }

      // --- 4. æ¸²æŸ“é‚è¼¯ (UI) ---

      /** æ¸²æŸ“æ‰€æœ‰é é¢ (ä¸»å‡½æ•¸) */
      function renderAllPages() {
        renderHomePage();
        renderAllPage();
        renderSettingsPage(); // æ›´æ–°å°å­˜è¨ˆæ•¸
      }

      /** ç”¢ç”Ÿå–®å€‹å¡ç‰‡çš„ HTML */
      function createEventCardHTML(event) {
        const countdown = calculateCountdown(event.date);
        
        const labelsHTML = (event.labels || [])
          .map(label => `<span class="card-label">${label}</span>`)
          .join('');
        
        let countdownHTML;
        if (event.status === 'Archived') {
          countdownHTML = `<span class="countdown-expired">å·²å°å­˜</span>`;
        } else if (countdown.status === 'today') {
          countdownHTML = `<div class="countdown-days">${countdown.days}</div>
                           <div class="countdown-unit">${countdown.unit}</div>`;
        } else if (countdown.status === 'expired') {
          // ç†è«–ä¸Šæœƒè¢« 'Archived' æ•æ‰åˆ°ï¼Œä½†ä½œç‚ºä¿éšª
           countdownHTML = `<div class="countdown-days">${countdown.days}</div>
                           <div class="countdown-unit">${countdown.unit}</div>`;
        } else {
           countdownHTML = `<div class="countdown-days">${countdown.days}</div>
                           <div class="countdown-unit">${countdown.unit}</div>`;
        }

        return `
          <div class="event-card ${event.status === 'Archived' ? 'archived' : ''}" data-id="${event.id}">
            <div class="card-details">
              ${labelsHTML ? `<div class="card-labels">${labelsHTML}</div>` : ''}
              <div class="card-title">${event.title}</div>
              ${event.subtitle ? `<div class="card-subtitle">${event.subtitle}</div>` : ''}
              <div class="card-date">${event.date}</div>
            </div>
            <div class="card-countdown">
              ${countdownHTML}
            </div>
          </div>
        `;
      }

      /** æ¸²æŸ“é¦–é  */
      function renderHomePage() {
        const pinnedEvents = events
          .filter(e => e.is_pinned && e.status === 'Active')
          .sort((a, b) => new Date(a.date) - new Date(b.date)); // æ—¥æœŸè¿‘çš„åœ¨ä¸Šé¢
          
        if (pinnedEvents.length === 0) {
          homeList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ğŸ“Œ</div>
              <p>å°šç„¡å®šé¸æ´»å‹•</p>
              <p>è«‹è‡³ã€Œå…¨éƒ¨ã€é é¢é»æ“Šæ´»å‹•å¡ç‰‡ä¾†å®šé¸</p>
            </div>`;
        } else {
          homeList.innerHTML = pinnedEvents.map(createEventCardHTML).join('');
        }
      }

      /** æ¸²æŸ“å…¨éƒ¨é é¢ */
      function renderAllPage() {
        const targetStatus = showArchived ? 'Archived' : 'Active';
        
        const filteredEvents = events
          .filter(e => e.status === targetStatus)
          .sort((a, b) => {
            // æ´»å‹•ä¸­ï¼šæ—¥æœŸè¿‘çš„åœ¨ä¸Šé¢ï¼› å·²å°å­˜ï¼šæ—¥æœŸè¿‘çš„(å‰›éæœŸ)åœ¨ä¸Šé¢
             return new Date(a.date) - new Date(b.date);
          });

        if (filteredEvents.length === 0) {
          allList.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">${showArchived ? 'ğŸ—„ï¸' : 'ğŸ‰'}</div>
              <p>${showArchived ? 'å°å­˜å€æ˜¯ç©ºçš„' : 'ç›®å‰æ²’æœ‰æ´»å‹•'}</p>
              ${!showArchived ? '<p>é»æ“Šå³ä¸‹è§’ + é–‹å§‹æ–°å¢</p>' : ''}
            </div>`;
        } else {
          allList.innerHTML = filteredEvents.map(createEventCardHTML).join('');
        }
        
        // æ›´æ–°æŒ‰éˆ•æ–‡å­—
        const archivedCount = events.filter(e => e.status === 'Archived').length;
        toggleArchivedBtn.textContent = `${showArchived ? 'éš±è—' : 'é¡¯ç¤º'}å·²å°å­˜ (${archivedCount})`;
      }

      /** æ¸²æŸ“è¨­å®šé é¢ */
      function renderSettingsPage() {
        // (æœªä¾†å¯æ“´å±•æ¨™ç±¤ç®¡ç†ç­‰)
        // ç›®å‰ä¸»è¦ç”¨æ–¼æ›´æ–°å°å­˜è¨ˆæ•¸
      }


      // --- 5. è¡¨å–® Modal é‚è¼¯ ---
      
      function showModal(event = null) {
        if (event) {
          // ç·¨è¼¯æ¨¡å¼
          formTitle.textContent = 'ç·¨è¼¯æ´»å‹•';
          formEventId.value = event.id;
          formTitleInput.value = event.title;
          formDateInput.value = event.date;
          formSubtitleInput.value = event.subtitle || '';
          formLabelsInput.value = (event.labels || []).join(', ');
          formRecurrenceInput.value = event.recurrence || 'None';
          formPinnedInput.checked = event.is_pinned;
          btnDelete.style.display = 'block';
        } else {
          // æ–°å¢æ¨¡å¼
          formTitle.textContent = 'æ–°å¢æ´»å‹•';
          formEventId.value = '';
          formTitleInput.value = '';
          formDateInput.value = '';
          formSubtitleInput.value = '';
          formLabelsInput.value = '';
          formRecurrenceInput.value = 'None';
          formPinnedInput.checked = false;
          btnDelete.style.display = 'none';
        }
        modal.style.display = 'flex';
      }

      function hideModal() {
        modal.style.display = 'none';
      }

      function handleFormSubmit() {
        const id = formEventId.value;
        const title = formTitleInput.value.trim();
        const date = formDateInput.value;

        if (!title || !date) {
          alert('è«‹è¼¸å…¥æ¨™é¡Œå’Œæ—¥æœŸï¼');
          return;
        }

        const eventData = {
          id: id || generateID(),
          title: title,
          subtitle: formSubtitleInput.value.trim() || '',
          date: date,
          labels: formLabelsInput.value.split(',').map(s => s.trim()).filter(Boolean),
          recurrence: formRecurrenceInput.value,
          is_pinned: formPinnedInput.checked,
          status: 'Active' // æ–°å¢æˆ–ç·¨è¼¯æ™‚ä¸€å¾‹è¨­ç‚º Active
        };

        if (id) {
          // ç·¨è¼¯
          const index = events.findIndex(e => e.id === id);
          if (index > -1) {
            events[index] = eventData;
          }
        } else {
          // æ–°å¢
          events.push(eventData);
        }

        saveData();
        renderAllPages();
        hideModal();
      }
      
      function handleDelete() {
        const id = formEventId.value;
        if (!id || !confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™å€‹æ´»å‹•å—ï¼Ÿ')) {
          return;
        }
        
        events = events.filter(e => e.id !== id);
        saveData();
        renderAllPages();
        hideModal();
      }


      // --- 6. äº‹ä»¶ç›£è½å™¨ (Event Listeners) ---

      /** å°è¦½åˆ—åˆ‡æ› */
      navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // ç§»é™¤æ‰€æœ‰ active
          navTabs.forEach(t => t.classList.remove('active'));
          pages.forEach(p => p.classList.remove('active'));
          
          // æ–°å¢ active
          tab.classList.add('active');
          const pageId = tab.dataset.page;
          document.getElementById(pageId).classList.add('active');

          // æ§åˆ¶ FAB é¡¯ç¤º
          fab.style.display = (pageId === 'page-all') ? 'block' : 'none';
        });
      });

      /** æ‡¸æµ®æŒ‰éˆ• */
      fab.addEventListener('click', () => showModal(null));

      /** è¡¨å–®æŒ‰éˆ• */
      btnCancel.addEventListener('click', hideModal);
      btnSave.addEventListener('click', handleFormSubmit);
      btnDelete.addEventListener('click', handleDelete);

      /** "å…¨éƒ¨" é é¢åˆ‡æ›å°å­˜ */
      toggleArchivedBtn.addEventListener('click', () => {
        showArchived = !showArchived;
        renderAllPage();
      });

      /** å¡ç‰‡é»æ“Š (äº‹ä»¶å§”æ´¾) - ç”¨æ–¼ç·¨è¼¯ */
      document.getElementById('main-content').addEventListener('click', (e) => {
        const card = e.target.closest('.event-card');
        if (!card) return;
        
        const id = card.dataset.id;
        const event = events.find(e => e.id === id);
        
        if (event) {
          showModal(event);
        }
      });
      
      /** è¨­å®šé é¢æŒ‰éˆ• */
      btnClearArchived.addEventListener('click', () => {
        if (confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ‰€æœ‰å·²å°å­˜çš„æ´»å‹•å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
          events = events.filter(e => e.status !== 'Archived');
          saveData();
          renderAllPages(); // é‡æ–°æ¸²æŸ“æ‰€æœ‰é é¢ (æ›´æ–°è¨ˆæ•¸)
        }
      });
      
      btnImportDefaults.addEventListener('click', async () => {
        // ç°¡æ˜“å°å…¥ç¯„ä¾‹ (åƒ…å°å…¥åœ‹å®šå‡æ—¥)
        try {
          // å‡è¨­æ‚¨å·²å°‡ JSON æ”¾åœ¨æŒ‡å®šè·¯å¾‘
          const response = await fetch('assets/default_data/national_holidays.json');
          if (!response.ok) throw new Error('ç„¡æ³•è¼‰å…¥é è¨­è³‡æ–™');
          
          const defaultEvents = await response.json();
          
          defaultEvents.forEach(event => {
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ (ç°¡æ˜“æª¢æŸ¥æ¨™é¡Œ)
            if (!events.some(e => e.title === event.title && e.date === event.date)) {
              events.push({
                ...event,
                id: generateID(),
                status: 'Active' // ç¢ºä¿ç‹€æ…‹æ­£ç¢º
              });
            }
          });
          
          saveData();
          checkAndArchiveEvents(); // å°å…¥å¾Œç«‹å³æª¢æŸ¥
          renderAllPages();
          alert(`æˆåŠŸå°å…¥ ${defaultEvents.length} å€‹é è¨­æ´»å‹•ï¼`);
          
        } catch (error) {
          console.error('å°å…¥å¤±æ•—:', error);
          alert('å°å…¥é è¨­æ´»å‹•å¤±æ•—ã€‚');
        }
      });
      
      // --- 7. PWA Service Worker è¨»å†Š ---
      function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
              .then(registration => {
                console.log('ServiceWorker è¨»å†ŠæˆåŠŸ, scope: ', registration.scope);
              })
              .catch(err => {
                console.log('ServiceWorker è¨»å†Šå¤±æ•—: ', err);
              });
          });
        }
      }
      
      // --- 8. æ‡‰ç”¨ç¨‹å¼å•Ÿå‹• (Init) ---
      function init() {
        loadData();
        checkAndArchiveEvents(); // æ¯æ¬¡å•Ÿå‹•æ™‚æª¢æŸ¥éæœŸ
        renderAllPages();
        
        // é è¨­é¡¯ç¤º "å…¨éƒ¨" é é¢çš„ FAB
        fab.style.display = 'none'; // é è¨­éš±è—ï¼Œç”±å°è¦½åˆ‡æ›æ§åˆ¶
        document.querySelector('.nav-tab[data-page="page-home"]').click(); // æ‰‹å‹•è§¸ç™¼é»æ“Šé¦–é 
        
        registerServiceWorker();
      }

      // å•Ÿå‹•ï¼
      init();
    });
  </script>

</body>
</html>
