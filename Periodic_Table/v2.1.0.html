<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元素週期表 PRO v2.1.0 (化學反應預測版)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#e2e8f0',
                            border: '#334155',
                            input: '#334155'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .dark .glass {
            background: rgba(30, 41, 59, 0.95);
        }
        
        @keyframes orbit { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .orbit-animation { animation: orbit linear infinite; }
        
        @keyframes spin-slow { from { transform: rotate3d(1, 1, 1, 0deg); } to { transform: rotate3d(1, 1, 1, 360deg); } }
        .spin-3d { animation: spin-slow 12s linear infinite; transform-style: preserve-3d; }

        body { overscroll-behavior: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Range Slider Styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4f46e5;
            margin-top: -6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #475569;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // ==========================================
        // 0. Icons
        // ==========================================
        const Icons = {
            Menu: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Layers: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>,
            Info: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>,
            Activity: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Thermometer: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>,
            Zap: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Square: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>,
            Circle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/></svg>,
            Droplets: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>,
            Calculator: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Grid: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>,
            List: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>,
            TrendingUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            ExternalLink: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>,
            Star: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            Hash: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>,
            Languages: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>,
            EyeOff: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></svg>,
            Map: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            Split: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 3h5v5"/><path d="M8 3H3v5"/><path d="M12 22v-8.3a4 4 0 0 0-1.172-2.872L3 3"/><path d="m15 9 6-6"/></svg>,
            Flask: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><line x1="8.5" x2="15.5" y1="2" y2="2"/><path d="M8.5 2h7"/><path d="M9 2v2"/><path d="M15 2v2"/></svg>,
            Moon: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>,
            Sun: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Download: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Box: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>,
            Scatter: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="5" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="19" r="2"/><circle cx="5" cy="19" r="2"/><circle cx="19" cy="5" r="2"/></svg>,
            Filter: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        };

        // ==========================================
        // 1. Constants
        // ==========================================
        const INFO_LAYERS = {
            ATOMIC_NUMBER: { id: 'atomicNumber', label: '原子序', type: 'text' },
            ATOMIC_MASS: { id: 'atomicMass', label: '原子量', type: 'text' },
            EN_TEXT: { id: 'electronegativity', label: '電負度', type: 'text' },
            STATE_ICON: { id: 'state', label: '物態圖標', type: 'icon' },
        };

        const MODAL_HEADER_COLORS = {
            'nonmetal': 'bg-blue-600 dark:bg-blue-800',
            'noble gas': 'bg-purple-600 dark:bg-purple-800',
            'alkali metal': 'bg-red-600 dark:bg-red-800',
            'alkaline earth metal': 'bg-orange-600 dark:bg-orange-800',
            'metalloid': 'bg-teal-600 dark:bg-teal-800',
            'halogen': 'bg-cyan-600 dark:bg-cyan-800',
            'transition metal': 'bg-yellow-600 dark:bg-yellow-700',
            'post-transition metal': 'bg-indigo-600 dark:bg-indigo-800',
            'lanthanide': 'bg-pink-600 dark:bg-pink-800',
            'actinide': 'bg-rose-600 dark:bg-rose-800',
            'unknown': 'bg-gray-600 dark:bg-gray-700'
        };

        const HEATMAP_MODES = {
            NONE: { id: 'none', label: '標準分類 (族群)', property: 'category' },
            DENSITY: { id: 'density', label: '密度 (g/cm³)', property: 'density', min: 0, max: 22.6, colorScale: 'blue' },
            MELTING: { id: 'meltingPoint', label: '熔點 (°C)', property: 'meltingPoint', min: -273, max: 3600, colorScale: 'red' },
            BOILING: { id: 'boilingPoint', label: '沸點 (°C)', property: 'boilingPoint', min: -269, max: 5600, colorScale: 'orange' },
            ELECTRONEGATIVITY: { id: 'electronegativity', label: '電負度', property: 'electronegativity', min: 0.7, max: 4.0, colorScale: 'viridis' },
            ATOMIC_RADIUS: { id: 'atomicRadius', label: '原子半徑 (pm)', property: 'atomicRadius', min: 25, max: 265, colorScale: 'green' },
        };

        const CATEGORY_COLORS = {
            'nonmetal': 'bg-blue-100 text-blue-900 border-blue-200 dark:bg-blue-900 dark:text-blue-100 dark:border-blue-700',
            'noble gas': 'bg-purple-100 text-purple-900 border-purple-200 dark:bg-purple-900 dark:text-purple-100 dark:border-purple-700',
            'alkali metal': 'bg-red-100 text-red-900 border-red-200 dark:bg-red-900 dark:text-red-100 dark:border-red-700',
            'alkaline earth metal': 'bg-orange-100 text-orange-900 border-orange-200 dark:bg-orange-900 dark:text-orange-100 dark:border-orange-700',
            'metalloid': 'bg-teal-100 text-teal-900 border-teal-200 dark:bg-teal-900 dark:text-teal-100 dark:border-teal-700',
            'halogen': 'bg-cyan-100 text-cyan-900 border-cyan-200 dark:bg-cyan-900 dark:text-cyan-100 dark:border-cyan-700',
            'transition metal': 'bg-yellow-100 text-yellow-900 border-yellow-200 dark:bg-yellow-900 dark:text-yellow-100 dark:border-yellow-700',
            'post-transition metal': 'bg-indigo-100 text-indigo-900 border-indigo-200 dark:bg-indigo-900 dark:text-indigo-100 dark:border-indigo-700',
            'lanthanide': 'bg-pink-100 text-pink-900 border-pink-200 dark:bg-pink-900 dark:text-pink-100 dark:border-pink-700',
            'actinide': 'bg-rose-100 text-rose-900 border-rose-200 dark:bg-rose-900 dark:text-rose-100 dark:border-rose-700',
            'unknown': 'bg-gray-100 text-gray-900 border-gray-200 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-600'
        };

        const RAW_DATA = `1|H|氫|Hydrogen|1.008|0.00008988|-259.1|-252.9|2.20|53|1|1|nonmetal
2|He|氦|Helium|4.0026|0.0001786|-272.2|-268.9|null|31|1|18|noble gas
3|Li|鋰|Lithium|6.94|0.534|180.5|1342|0.98|167|2|1|alkali metal
4|Be|鈹|Beryllium|9.0122|1.85|1287|2469|1.57|112|2|2|alkaline earth metal
5|B|硼|Boron|10.81|2.34|2075|4000|2.04|87|2|13|metalloid
6|C|碳|Carbon|12.011|2.267|3550|4827|2.55|67|2|14|nonmetal
7|N|氮|Nitrogen|14.007|0.00125|-210.1|-195.8|3.04|56|2|15|nonmetal
8|O|氧|Oxygen|15.999|0.001429|-218.8|-183.0|3.44|48|2|16|nonmetal
9|F|氟|Fluorine|18.998|0.001696|-219.6|-188.1|3.98|42|2|17|halogen
10|Ne|氖|Neon|20.180|0.00090|-248.6|-246.1|null|38|2|18|noble gas
11|Na|鈉|Sodium|22.990|0.968|97.7|883|0.93|190|3|1|alkali metal
12|Mg|鎂|Magnesium|24.305|1.738|650|1090|1.31|145|3|2|alkaline earth metal
13|Al|鋁|Aluminium|26.982|2.70|660.3|2519|1.61|118|3|13|post-transition metal
14|Si|矽|Silicon|28.085|2.33|1414|3265|1.90|111|3|14|metalloid
15|P|磷|Phosphorus|30.974|1.823|44.15|280.5|2.19|98|3|15|nonmetal
16|S|硫|Sulfur|32.06|1.96|115.2|444.6|2.58|88|3|16|nonmetal
17|Cl|氯|Chlorine|35.45|0.0032|-101.5|-34.04|3.16|79|3|17|halogen
18|Ar|氬|Argon|39.948|0.00178|-189.3|-185.8|null|71|3|18|noble gas
19|K|鉀|Potassium|39.098|0.862|63.38|759|0.82|243|4|1|alkali metal
20|Ca|鈣|Calcium|40.078|1.55|842|1484|1.00|194|4|2|alkaline earth metal
21|Sc|鈧|Scandium|44.956|2.985|1541|2836|1.36|184|4|3|transition metal
22|Ti|鈦|Titanium|47.867|4.506|1668|3287|1.54|176|4|4|transition metal
23|V|釩|Vanadium|50.942|6.11|1910|3407|1.63|171|4|5|transition metal
24|Cr|鉻|Chromium|51.996|7.19|1907|2671|1.66|166|4|6|transition metal
25|Mn|錳|Manganese|54.938|7.21|1246|2061|1.55|161|4|7|transition metal
26|Fe|鐵|Iron|55.845|7.874|1538|2862|1.83|156|4|8|transition metal
27|Co|鈷|Cobalt|58.933|8.90|1495|2927|1.88|152|4|9|transition metal
28|Ni|鎳|Nickel|58.693|8.908|1455|2913|1.91|149|4|10|transition metal
29|Cu|銅|Copper|63.546|8.96|1084.6|2562|1.90|145|4|11|transition metal
30|Zn|鋅|Zinc|65.38|7.14|419.5|907|1.65|142|4|12|transition metal
31|Ga|鎵|Gallium|69.723|5.91|29.76|2204|1.81|136|4|13|post-transition metal
32|Ge|鍺|Germanium|72.630|5.323|938.25|2833|2.01|125|4|14|metalloid
33|As|砷|Arsenic|74.922|5.727|817|614|2.18|114|4|15|metalloid
34|Se|硒|Selenium|78.96|4.81|221|685|2.55|103|4|16|nonmetal
35|Br|溴|Bromine|79.904|3.1028|-7.2|58.8|2.96|120|4|17|halogen
36|Kr|氪|Krypton|83.798|0.00375|-157.4|-153.2|3.00|98|4|18|noble gas
37|Rb|銣|Rubidium|85.468|1.532|39.30|688|0.82|265|5|1|alkali metal
38|Sr|鍶|Strontium|87.62|2.64|777|1382|0.95|219|5|2|alkaline earth metal
39|Y|釔|Yttrium|88.906|4.472|1526|3336|1.22|212|5|3|transition metal
40|Zr|鋯|Zirconium|91.224|6.52|1855|4409|1.33|206|5|4|transition metal
41|Nb|鈮|Niobium|92.906|8.57|2477|4744|1.6|198|5|5|transition metal
42|Mo|鉬|Molybdenum|95.95|10.28|2623|4639|2.16|190|5|6|transition metal
43|Tc|鎝|Technetium|98|11|2157|4265|1.9|183|5|7|transition metal
44|Ru|釕|Ruthenium|101.07|12.45|2334|4150|2.2|178|5|8|transition metal
45|Rh|銠|Rhodium|102.91|12.41|1964|3695|2.28|173|5|9|transition metal
46|Pd|鈀|Palladium|106.42|12.02|1555|2963|2.20|169|5|10|transition metal
47|Ag|銀|Silver|107.87|10.49|961.8|2162|1.93|165|5|11|transition metal
48|Cd|鎘|Cadmium|112.41|8.65|321.07|767|1.69|161|5|12|transition metal
49|In|銦|Indium|114.82|7.31|156.60|2072|1.78|156|5|13|post-transition metal
50|Sn|錫|Tin|118.71|7.31|231.93|2602|1.96|145|5|14|post-transition metal
51|Sb|銻|Antimony|121.76|6.697|630.63|1587|2.05|133|5|15|metalloid
52|Te|碲|Tellurium|127.60|6.24|449.51|988|2.1|123|5|16|metalloid
53|I|碘|Iodine|126.90|4.933|113.7|184.3|2.66|115|5|17|halogen
54|Xe|氙|Xenon|131.29|0.0059|-111.7|-108.1|2.6|108|5|18|noble gas
55|Cs|銫|Cesium|132.91|1.93|28.44|671|0.79|298|6|1|alkali metal
56|Ba|鋇|Barium|137.33|3.51|727|1897|0.89|253|6|2|alkaline earth metal
57|La|鑭|Lanthanum|138.91|6.162|920|3464|1.1|null|8|3|lanthanide
58|Ce|鈰|Cerium|140.12|6.770|795|3443|1.12|null|8|4|lanthanide
59|Pr|鐠|Praseodymium|140.91|6.77|935|3520|1.13|247|8|5|lanthanide
60|Nd|釹|Neodymium|144.24|7.01|1024|3074|1.14|206|8|6|lanthanide
61|Pm|鉕|Promethium|145|7.26|1042|3000|1.13|205|8|7|lanthanide
62|Sm|釤|Samarium|150.36|7.52|1072|1794|1.17|238|8|8|lanthanide
63|Eu|銪|Europium|151.96|5.244|822|1529|1.2|231|8|9|lanthanide
64|Gd|釓|Gadolinium|157.25|7.90|1312|3273|1.2|233|8|10|lanthanide
65|Tb|鋱|Terbium|158.93|8.23|1356|3230|1.2|225|8|11|lanthanide
66|Dy|鏑|Dysprosium|162.50|8.540|1412|2567|1.22|228|8|12|lanthanide
67|Ho|鈥|Holmium|164.93|8.79|1472|2700|1.23|226|8|13|lanthanide
68|Er|鉺|Erbium|167.26|9.066|1529|2868|1.24|226|8|14|lanthanide
69|Tm|銩|Thulium|168.93|9.32|1545|1950|1.25|222|8|15|lanthanide
70|Yb|鐿|Ytterbium|173.05|6.90|824|1196|1.1|222|8|16|lanthanide
71|Lu|鎦|Lutetium|174.97|9.841|1663|3402|1.27|217|8|17|lanthanide
72|Hf|鉿|Hafnium|178.49|13.31|2233|4603|1.3|208|6|4|transition metal
73|Ta|鉭|Tantalum|180.95|16.69|3017|5458|1.5|200|6|5|transition metal
74|W|鎢|Tungsten|183.84|19.25|3422|5930|2.36|193|6|6|transition metal
75|Re|錸|Rhenium|186.21|21.02|3186|5596|1.9|188|6|7|transition metal
76|Os|鋨|Osmium|190.23|22.59|3033|5012|2.2|185|6|8|transition metal
77|Ir|銥|Iridium|192.22|22.56|2446|4428|2.20|180|6|9|transition metal
78|Pt|鉑|Platinum|195.08|21.45|1768|3825|2.28|177|6|10|transition metal
79|Au|金|Gold|196.97|19.30|1064.2|2970|2.54|174|6|11|transition metal
80|Hg|汞|Mercury|200.59|13.534|-38.83|356.7|2.00|171|6|12|transition metal
81|Tl|鉈|Thallium|204.38|11.85|304|1473|1.62|156|6|13|post-transition metal
82|Pb|鉛|Lead|207.2|11.34|327.46|1749|2.33|154|6|14|post-transition metal
83|Bi|鉍|Bismuth|208.98|9.78|271.3|1564|2.02|143|6|15|post-transition metal
84|Po|釙|Polonium|209|9.196|254|962|2.0|135|6|16|post-transition metal
85|At|砈|Astatine|210|null|302|337|2.2|null|6|17|metalloid
86|Rn|氡|Radon|222|0.00973|-71|-61.7|2.2|120|6|18|noble gas
87|Fr|鍅|Francium|223|1.87|27|677|0.7|null|7|1|alkali metal
88|Ra|鐳|Radium|226|5.50|700|1737|0.9|null|7|2|alkaline earth metal
89|Ac|錒|Actinium|227|10.07|1050|3198|1.1|null|9|3|actinide
90|Th|釷|Thorium|232.04|11.72|1750|4788|1.3|null|9|4|actinide
91|Pa|鏷|Protactinium|231.04|15.37|1568|4027|1.5|null|9|5|actinide
92|U|鈾|Uranium|238.03|19.1|1132|4131|1.38|null|9|6|actinide
93|Np|錼|Neptunium|237|20.45|644|3902|1.36|null|9|7|actinide
94|Pu|鈽|Plutonium|244|19.82|640|3228|1.28|null|9|8|actinide
95|Am|鋂|Americium|243|13.67|1176|2607|1.13|null|9|9|actinide
96|Cm|鋦|Curium|247|13.51|1340|3110|1.28|null|9|10|actinide
97|Bk|鉳|Berkelium|247|14.78|986|null|1.3|null|9|11|actinide
98|Cf|鉲|Californium|251|15.1|900|null|1.3|null|9|12|actinide
99|Es|鑀|Einsteinium|252|8.84|860|null|1.3|null|9|13|actinide
100|Fm|鐨|Fermium|257|null|1527|null|1.3|null|9|14|actinide
101|Md|鍆|Mendelevium|258|null|827|null|1.3|null|9|15|actinide
102|No|鍩|Nobelium|259|null|827|null|1.3|null|9|16|actinide
103|Lr|鐒|Lawrencium|262|null|1627|null|1.3|null|9|17|actinide
104|Rf|鑪|Rutherfordium|267|23.2|2100|5500|null|null|7|4|transition metal
105|Db|𨧀|Dubnium|268|29.3|null|null|null|null|7|5|transition metal
106|Sg|𨭎|Seaborgium|271|35.0|null|null|null|null|7|6|transition metal
107|Bh|𨨏|Bohrium|272|37.1|null|null|null|null|7|7|transition metal
108|Hs|𨭆|Hassium|270|40.7|null|null|null|null|7|8|transition metal
109|Mt|䥑|Meitnerium|276|37.4|null|null|null|null|7|9|unknown
110|Ds|鐽|Darmstadtium|281|34.8|null|null|null|null|7|10|unknown
111|Rg|錀|Roentgenium|280|28.7|null|null|null|null|7|11|unknown
112|Cn|鎶|Copernicium|285|23.7|null|357|null|null|7|12|unknown
113|Nh|鉨|Nihonium|284|16|400|1100|null|null|7|13|unknown
114|Fl|鈇|Flerovium|289|14|60|150|null|null|7|14|unknown
115|Mc|鏌|Moscovium|288|13.5|400|1100|null|null|7|15|unknown
116|Lv|鉝|Livermorium|293|12.9|400|800|null|null|7|16|unknown
117|Ts|鿬|Tennessine|294|7.2|400|550|null|null|7|17|unknown
118|Og|鿫|Oganesson|294|5.0|50|80|null|null|7|18|unknown
`;

        const getExtraData = (number, group, category) => {
            const getShells = (n) => {
                const shells = [];
                let remaining = n;
                const capacity = [2, 8, 18, 32, 32, 18, 8];
                for (let cap of capacity) {
                    if (remaining <= 0) break;
                    let fill = Math.min(remaining, cap);
                    if (n > 2 && shells.length === 1 && remaining > 8) fill = 8; 
                    shells.push(fill);
                    remaining -= fill;
                }
                const commonShells = { 1:[1], 2:[2], 11:[2,8,1], 19:[2,8,8,1] };
                return commonShells[n] || shells;
            };
            
            const shells = getShells(number);
            const valance = shells[shells.length-1];
            
            const compoundsMap = {
                1: ['H₂O', 'NH₃', 'CH₄'], 6: ['CO₂', 'CH₄'], 7: ['NH₃', 'NO₂'], 8: ['H₂O', 'CO₂'],
                11: ['NaCl', 'NaOH'], 17: ['NaCl', 'HCl'], 26: ['Fe₂O₃', 'FeCl₃']
            };

            // Dummy Isotope Data
            const isotopes = [
                { mass: number + 1, abundance: '0.01%' },
                { mass: number, abundance: '99.9%' },
                { mass: number + 2, abundance: 'Trace' }
            ];

            // Heuristic for crystal structure
            let structure = 'simple';
            if ([3, 11, 19, 37, 55, 23, 24, 26, 41, 42, 73, 74].includes(number)) structure = 'bcc';
            else if ([13, 28, 29, 47, 78, 79, 82].includes(number) || (group === 18 && number > 2)) structure = 'fcc';
            else if ([4, 12, 22, 30, 40, 44, 48].includes(number)) structure = 'hcp';
            else if ([6, 14, 32, 50].includes(number)) structure = 'diamond';

            return {
                shells,
                config: number <= 2 ? (number===1?"1s¹":"1s²") : `[..] ${valance}e⁻`,
                compounds: compoundsMap[number] || [],
                structure,
                isotopes
            };
        };

        const parseElements = () => {
            return RAW_DATA.trim().split('\n').map(line => {
                const [num, sym, zh, en, mass, den, melt, boil, enVal, rad, per, grp, cat] = line.split('|');
                const parseNum = (v) => v === 'null' ? null : parseFloat(v);
                const n = parseInt(num);
                const g = parseInt(grp);
                return {
                    number: n, symbol: sym, nameZh: zh, nameEn: en,
                    atomicMass: parseNum(mass), density: parseNum(den),
                    meltingPoint: parseNum(melt), boilingPoint: parseNum(boil),
                    electronegativity: parseNum(enVal), atomicRadius: parseNum(rad),
                    period: parseInt(per), group: g, category: cat,
                    ...getExtraData(n, g, cat)
                };
            });
        };

        const elementsData = parseElements();

        // ==========================================
        // 3. Logic Helpers
        // ==========================================
        const getHeatmapColor = (value, mode, useBanding) => {
            if (value === null || value === undefined) return 'bg-gray-100 dark:bg-gray-700 text-gray-300 dark:text-gray-500';
            if (mode.id === 'none') return ''; 
            const { min, max, colorScale } = mode;
            let ratio = Math.max(0, Math.min(1, (value - min) / (max - min)));
            if (useBanding) { const bands = 5; ratio = Math.floor(ratio * bands) / bands; }
            
            const scales = {
                blue: `hsl(210, 85%, ${95 - ratio * 75}%)`,
                red: `hsl(${50 - ratio * 50}, 95%, ${95 - ratio * 55}%)`,
                orange: `hsl(30, 100%, ${95 - ratio * 60}%)`,
                green: `hsl(140, 80%, ${95 - ratio * 70}%)`,
                viridis: `hsl(${260 - ratio * 260}, 75%, 60%)`
            };
            const bg = scales[colorScale] || scales.blue;
            if (colorScale === 'viridis') return { backgroundColor: bg, color: 'white' };
            return { backgroundColor: bg, color: (ratio > 0.6) ? 'white' : 'black' }; 
        };

        const calculateState = (element, temperatureKelvin) => {
            const tempC = temperatureKelvin - 273.15;
            const { meltingPoint, boilingPoint } = element;
            if (meltingPoint === null && boilingPoint === null) return 'unknown';
            const mp = meltingPoint !== null ? meltingPoint : -273;
            const bp = boilingPoint !== null ? boilingPoint : 99999;
            if (tempC < mp) return 'solid';
            if (tempC >= mp && tempC < bp) return 'liquid';
            return 'gas';
        };

        // ==========================================
        // 4. Visualizers
        // ==========================================
        const CrystalVisualizer = ({ structure }) => {
            const renderDots = () => {
                if (structure === 'bcc') {
                    return [
                        ...[0,100].flatMap(x=>[0,100].flatMap(y=>[0,100].map(z=><div key={`c-${x}${y}${z}`} className="absolute w-2 h-2 bg-indigo-500 rounded-full" style={{transform: `translate3d(${x-2}px, ${y-2}px, ${z-2}px)`}}/>))),
                        <div key="center" className="absolute w-3 h-3 bg-red-500 rounded-full" style={{transform: `translate3d(48px, 48px, 48px)`}}/>
                    ];
                }
                if (structure === 'fcc') {
                    return [
                        ...[0,100].flatMap(x=>[0,100].flatMap(y=>[0,100].map(z=><div key={`c-${x}${y}${z}`} className="absolute w-2 h-2 bg-indigo-500 rounded-full" style={{transform: `translate3d(${x-2}px, ${y-2}px, ${z-2}px)`}}/>))),
                        <div key="f1" className="absolute w-2 h-2 bg-green-500 rounded-full" style={{transform: `translate3d(48px, 48px, 0px)`}}/>,
                        <div key="f2" className="absolute w-2 h-2 bg-green-500 rounded-full" style={{transform: `translate3d(48px, 48px, 98px)`}}/>,
                        <div key="f3" className="absolute w-2 h-2 bg-green-500 rounded-full" style={{transform: `translate3d(48px, 0px, 48px)`}}/>,
                        <div key="f4" className="absolute w-2 h-2 bg-green-500 rounded-full" style={{transform: `translate3d(48px, 98px, 48px)`}}/>,
                        <div key="f5" className="absolute w-2 h-2 bg-green-500 rounded-full" style={{transform: `translate3d(0px, 48px, 48px)`}}/>,
                        <div key="f6" className="absolute w-2 h-2 bg-green-500 rounded-full" style={{transform: `translate3d(98px, 48px, 48px)`}}/>
                    ];
                }
                return [0,100].flatMap(x=>[0,100].flatMap(y=>[0,100].map(z=><div key={`s-${x}${y}${z}`} className="absolute w-2 h-2 bg-gray-400 rounded-full" style={{transform: `translate3d(${x-2}px, ${y-2}px, ${z-2}px)`}}/>)));
            };

            return (
                <div className="relative w-32 h-32 flex items-center justify-center perspective-500">
                    <div className="w-24 h-24 relative spin-3d border border-gray-300 dark:border-gray-600 box-border">
                        {renderDots()}
                        <div className="absolute inset-0 border border-indigo-200/50"></div>
                        <div className="absolute inset-0 border border-indigo-200/50" style={{transform: 'translateZ(100px)'}}></div>
                    </div>
                </div>
            );
        };

        const OrbitalBoxDiagram = ({ shells }) => {
            const valance = shells[shells.length - 1];
            const boxes = [];
            const pairs = Math.floor(valance / 2);
            const singles = valance % 2;
            
            for(let i=0; i<4; i++) { 
                let content = null;
                if (i < pairs + singles) {
                    if (i < pairs) content = <span className="flex text-[10px] leading-none"><span>↑</span><span className="rotate-180">↑</span></span>;
                    else if (singles) content = <span className="text-[10px] leading-none">↑</span>;
                }
                boxes.push(
                    <div key={i} className="w-6 h-6 border border-gray-400 dark:border-gray-500 flex items-center justify-center bg-white dark:bg-gray-800 text-gray-800 dark:text-white">
                        {content}
                    </div>
                );
            }
            return <div className="flex gap-1 mt-2">{boxes}</div>;
        };

        // ==========================================
        // 5. Components
        // ==========================================

        const ElementCell = ({ element, activeLayers, heatmapMode, onSelect, currentTemp, highlightCategory, calcMode, onCalcAdd, lang, isFavorite, simpleMode, filterState, useBanding, compareMode, onAddToCompare, isSelectedForCompare, customDataMode }) => {
            const modeConfig = HEATMAP_MODES[heatmapMode];
            let style = {};
            let className = "relative border flex flex-col justify-center items-center cursor-pointer transition-all rounded-sm select-none ";
            className += simpleMode ? "p-0.5 " : "p-0.5 sm:p-1 ";

            if (heatmapMode === 'NONE') {
                if (highlightCategory && element.category !== highlightCategory) {
                    className += "bg-gray-50 text-gray-300 border-gray-100 dark:bg-gray-800 dark:text-gray-600 dark:border-gray-700 ";
                } else {
                    className += CATEGORY_COLORS[element.category] || 'bg-gray-100 text-gray-500 border-gray-200';
                }
            } else {
                const colorStyle = getHeatmapColor(element[modeConfig.property], modeConfig, useBanding);
                if (colorStyle.backgroundColor) {
                    style = colorStyle;
                    className += "border-transparent ";
                } else {
                    className += colorStyle; 
                }
            }

            if (calcMode) className += " active:scale-95 active:ring-2 active:ring-indigo-400";
            else if (compareMode) {
                if (isSelectedForCompare) className += " ring-2 ring-indigo-600 z-50 transform scale-110";
                else className += " hover:ring-2 hover:ring-indigo-400";
            }
            else className += " hover:scale-125 hover:z-50 hover:shadow-lg";

            const dynamicState = calculateState(element, currentTemp);

            if (filterState !== 'all' && dynamicState !== filterState && dynamicState !== 'unknown') {
                className += " opacity-20 grayscale";
            }

            const handleClick = () => {
                if (calcMode) onCalcAdd(element);
                else if (compareMode) onAddToCompare(element);
                else onSelect(element);
            };

            const getCustomData = () => {
                if (customDataMode === 'mass') return Math.round(element.atomicMass * 100) / 100;
                if (customDataMode === 'radius') return element.atomicRadius || '-';
                if (customDataMode === 'shells') return element.shells.length;
                return element.electronegativity || '-';
            };

            return (
                <div className={className} style={{ ...style, gridColumn: element.group, gridRow: element.period }} onClick={handleClick}>
                    <div className="text-[7px] sm:text-[9px] absolute top-0.5 left-1 opacity-60 font-mono leading-none">{activeLayers.ATOMIC_NUMBER && element.number}</div>
                    {isFavorite && <div className="absolute top-0.5 right-0.5 text-yellow-500"><Icons.Star size={8} fill="currentColor"/></div>}
                    <div className={`font-bold leading-none ${element.symbol.length > 2 ? 'text-xs sm:text-sm' : 'text-sm sm:text-lg md:text-xl'}`}>{element.symbol}</div>
                    {!simpleMode && (
                        <div className="text-[8px] sm:text-[9px] transform scale-90 sm:scale-100 truncate w-full text-center opacity-90 hidden sm:block">
                            {lang === 'zh' ? element.nameZh : element.nameEn}
                        </div>
                    )}
                    {!simpleMode && activeLayers.EN_TEXT && (
                        <div className="hidden md:block absolute top-0.5 right-0.5 text-[7px] font-mono text-gray-700 bg-white/50 px-0.5 rounded backdrop-blur-sm">
                            {getCustomData()}
                        </div>
                    )}
                    {!simpleMode && activeLayers.ATOMIC_MASS && customDataMode !== 'mass' && element.atomicMass && (
                        <div className="hidden lg:block text-[8px] opacity-70 mt-[-2px] transform scale-75 font-mono">{Math.round(element.atomicMass * 100) / 100}</div>
                    )}
                    {activeLayers.STATE_ICON && dynamicState !== 'unknown' && (
                        <div className={`absolute bottom-0.5 right-0.5 w-1.5 h-1.5 sm:w-2 sm:h-2 shadow-sm ${
                            dynamicState === 'gas' ? 'bg-green-400 border border-white rounded-full' : 
                            dynamicState === 'liquid' ? 'bg-blue-500 border border-white rounded-full' : 
                            dynamicState === 'solid' ? 'bg-gray-400 border border-white rounded-[1px]' : 'hidden'
                        }`} />
                    )}
                </div>
            );
        };

        const Legend = ({ mode, useBanding }) => {
            if (mode === 'NONE') return null;
            const config = HEATMAP_MODES[mode];
            const bands = 5;
            return (
                <div className="mt-4 bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                    <div className="flex justify-between text-[10px] text-gray-500 dark:text-gray-400 mb-1 font-mono"><span>{config.min}</span><span>{config.max}</span></div>
                    {useBanding ? (
                        <div className="flex h-3 w-full rounded-full overflow-hidden border border-gray-100 dark:border-gray-600">
                            {[...Array(bands)].map((_, i) => {
                                const colorStyle = getHeatmapColor(config.min + (config.max - config.min) * (i / (bands-1)), config, false); 
                                return <div key={i} className="flex-1" style={{ backgroundColor: getHeatmapColor(config.min + (config.max - config.min) * (i/4), config, false).backgroundColor }}></div>
                            })}
                        </div>
                    ) : (
                        <div className={`h-3 rounded-full w-full bg-gradient-to-r ${config.colorScale === 'blue' ? 'from-blue-100 to-blue-900' : config.colorScale === 'red' ? 'from-yellow-100 via-red-500 to-red-900' : config.colorScale === 'viridis' ? 'from-blue-500 via-green-500 to-red-500' : config.colorScale === 'orange' ? 'from-orange-100 to-orange-900' : 'from-green-100 to-green-900'}`}></div>
                    )}
                    <div className="text-[10px] text-center mt-1 text-gray-400">{useBanding ? '分層顯示' : '連續漸層'}</div>
                </div>
            );
        };

        const ListView = ({ elements, onSelect, lang, onSort }) => {
            return (
                <div className="overflow-x-auto min-w-full bg-white dark:bg-gray-800 rounded-lg shadow border dark:border-gray-700">
                    <table className="min-w-full text-sm text-left text-gray-600 dark:text-gray-300">
                        <thead className="bg-gray-50 dark:bg-gray-700 font-bold border-b dark:border-gray-600">
                            <tr>
                                <th className="px-4 py-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600">#</th>
                                <th className="px-4 py-3">符號</th>
                                <th className="px-4 py-3">名稱</th>
                                <th className="px-4 py-3">類別</th>
                                <th className="px-4 py-3">質量</th>
                                <th className="px-4 py-3">密度</th>
                                <th className="px-4 py-3">熔點</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100 dark:divide-gray-700">
                            {elements.map(el => (
                                <tr key={el.number} onClick={() => onSelect(el)} className="hover:bg-indigo-50 dark:hover:bg-indigo-900/30 cursor-pointer transition-colors">
                                    <td className="px-4 py-2 font-mono opacity-70">{el.number}</td>
                                    <td className="px-4 py-2 font-bold text-indigo-700 dark:text-indigo-400">{el.symbol}</td>
                                    <td className="px-4 py-2"><div>{lang === 'zh' ? el.nameZh : el.nameEn}</div></td>
                                    <td className="px-4 py-2"><span className={`px-2 py-0.5 rounded text-xs border ${CATEGORY_COLORS[el.category].split(' ')[0]} ${CATEGORY_COLORS[el.category].split(' ')[1]} border-opacity-50`}>{el.category}</span></td>
                                    <td className="px-4 py-2 font-mono">{el.atomicMass}</td>
                                    <td className="px-4 py-2 font-mono">{el.density}</td>
                                    <td className="px-4 py-2 font-mono">{el.meltingPoint}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        };

        const GraphView = ({ elements, heatmapMode, scatterConfig, setScatterConfig }) => {
            const width = 1000, height = 400, padding = 50;
            const isScatter = scatterConfig.enabled;
            const xProp = isScatter ? scatterConfig.x : 'number';
            const yProp = isScatter ? scatterConfig.y : (heatmapMode === 'NONE' ? 'atomicRadius' : HEATMAP_MODES[heatmapMode].property);
            
            const dataPoints = elements
                .filter(el => el[xProp] !== null && el[yProp] !== null && typeof el[xProp] === 'number' && typeof el[yProp] === 'number')
                .sort((a, b) => a.number - b.number);

            if (dataPoints.length === 0) return <div className="p-8 text-center text-gray-400">無可用數據</div>;

            const xMax = Math.max(...dataPoints.map(d => d[xProp]));
            const xMin = Math.min(...dataPoints.map(d => d[xProp]));
            const yMax = Math.max(...dataPoints.map(d => d[yProp]));
            const yMin = Math.min(...dataPoints.map(d => d[yProp]));

            const getX = (val) => padding + ((val - xMin) / (xMax - xMin)) * (width - padding * 2);
            const getY = (val) => height - padding - ((val - yMin) / (yMax - yMin)) * (height - padding * 2);

            return (
                <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border dark:border-gray-700 overflow-x-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold text-gray-700 dark:text-gray-200 flex items-center gap-2"><Icons.TrendingUp size={20}/> {isScatter ? '散佈圖分析' : '趨勢圖'}</h3>
                        <div className="flex gap-2 text-sm">
                            <select className="border rounded bg-gray-50 dark:bg-gray-700 dark:text-white px-2 py-1" value={scatterConfig.x} onChange={e => setScatterConfig({...scatterConfig, x: e.target.value, enabled: true})}>
                                <option value="number">原子序</option>
                                <option value="atomicMass">原子量</option>
                                <option value="density">密度</option>
                                <option value="meltingPoint">熔點</option>
                                <option value="electronegativity">電負度</option>
                            </select>
                            <span className="self-center">vs</span>
                            <select className="border rounded bg-gray-50 dark:bg-gray-700 dark:text-white px-2 py-1" value={scatterConfig.y} onChange={e => setScatterConfig({...scatterConfig, y: e.target.value, enabled: true})}>
                                <option value="atomicRadius">半徑</option>
                                <option value="density">密度</option>
                                <option value="meltingPoint">熔點</option>
                                <option value="boilingPoint">沸點</option>
                                <option value="electronegativity">電負度</option>
                            </select>
                        </div>
                    </div>
                    <div className="min-w-[800px]">
                        <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto">
                            <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#ccc" strokeWidth="2" />
                            <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#ccc" strokeWidth="2" />
                            {dataPoints.map(d => (
                                <circle key={d.number} cx={getX(d[xProp])} cy={getY(d[yProp])} r="4" className="fill-indigo-500/60 hover:fill-red-500 cursor-pointer transition-colors">
                                    <title>{d.symbol}: X={d[xProp]}, Y={d[yProp]}</title>
                                </circle>
                            ))}
                            {!isScatter && <polyline fill="none" stroke="#6366f1" strokeWidth="2" points={dataPoints.map(d => `${getX(d[xProp])},${getY(d[yProp])}`).join(' ')} opacity="0.3" />}
                            <text x={width/2} y={height-10} textAnchor="middle" fill="gray" fontSize="12">{xProp}</text>
                            <text x={10} y={height/2} textAnchor="middle" transform={`rotate(-90, 10, ${height/2})`} fill="gray" fontSize="12">{yProp}</text>
                        </svg>
                    </div>
                </div>
            );
        };

        const AtomVisualizer = ({ shells }) => (
            <div className="relative w-32 h-32 md:w-40 md:h-40 mx-auto my-4 flex items-center justify-center">
                <div className="absolute w-4 h-4 bg-red-500 rounded-full z-10 shadow-lg"></div>
                {shells.map((count, i) => (
                    <div key={i} className="absolute border border-gray-400/50 rounded-full flex items-center justify-center orbit-animation" style={{ width: `${(i+1)*25+10}%`, height: `${(i+1)*25+10}%`, animationDuration: `${(i+1)*5}s` }}>
                        {[...Array(count)].map((_, j) => <div key={j} className="absolute w-1.5 h-1.5 bg-blue-400 rounded-full" style={{ transform: `rotate(${(360/count)*j}deg) translate(${(i+1)*16+6}px)` }} />)}
                    </div>
                ))}
            </div>
        );

        const ComparisonModal = ({ items, onClose, lang }) => {
            if (items.length < 2) return null;
            const [e1, e2] = items;
            
            // Bond Prediction Logic
            const deltaEN = Math.abs((e1.electronegativity || 0) - (e2.electronegativity || 0));
            let bondType = "未知/無法判斷";
            let bondDesc = "";
            const isMetal = (cat) => cat.includes("metal") && !cat.includes("metalloid");
            
            if (e1.electronegativity && e2.electronegativity) {
                if (isMetal(e1.category) && isMetal(e2.category)) {
                    bondType = "金屬鍵 (Metallic)";
                    bondDesc = "電子海共享";
                } else if (deltaEN > 1.7) {
                    bondType = "離子鍵 (Ionic)";
                    bondDesc = "電子轉移";
                } else if (deltaEN > 0.4) {
                    bondType = "極性共價鍵 (Polar Covalent)";
                    bondDesc = "電子不均等共享";
                } else {
                    bondType = "非極性共價鍵 (Nonpolar Covalent)";
                    bondDesc = "電子均等共享";
                }
            }

            const renderRow = (label, key, unit='') => (
                <div className="grid grid-cols-3 gap-2 py-2 border-b border-gray-100 dark:border-gray-700 text-sm">
                    <div className="text-gray-500 dark:text-gray-400 font-medium">{label}</div>
                    <div className="text-center font-mono text-gray-800 dark:text-gray-200">{e1[key] ?? '-'} {unit}</div>
                    <div className="text-center font-mono text-gray-800 dark:text-gray-200">{e2[key] ?? '-'} {unit}</div>
                </div>
            );

            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-900 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="p-4 bg-indigo-900 text-white flex justify-between items-center">
                            <h2 className="text-xl font-bold flex items-center gap-2"><Icons.Split size={20}/> 元素對比與反應預測</h2>
                            <button onClick={onClose}><Icons.X size={24}/></button>
                        </div>
                        <div className="p-6">
                            <div className="grid grid-cols-3 gap-2 mb-4 text-center">
                                <div></div>
                                <div className="text-3xl font-bold text-indigo-600 dark:text-indigo-400">{e1.symbol}</div>
                                <div className="text-3xl font-bold text-pink-600 dark:text-pink-400">{e2.symbol}</div>
                                <div></div>
                                <div className="text-sm text-gray-500 dark:text-gray-400">{lang==='zh'?e1.nameZh:e1.nameEn}</div>
                                <div className="text-sm text-gray-500 dark:text-gray-400">{lang==='zh'?e2.nameZh:e2.nameEn}</div>
                            </div>
                            
                            {/* Reaction Prediction Panel */}
                            <div className="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-800 p-4 rounded-lg mb-6 border border-blue-100 dark:border-slate-700">
                                <h3 className="text-sm font-bold text-blue-900 dark:text-blue-300 mb-2 flex items-center gap-2"><Icons.Flask size={16}/> 化學鍵預測</h3>
                                <div className="flex justify-between items-center">
                                    <div className="text-xs text-gray-500 dark:text-gray-400">電負度差 (ΔEN): <span className="font-mono font-bold text-lg text-blue-600 dark:text-blue-400">{deltaEN.toFixed(2)}</span></div>
                                    <div className="text-right">
                                        <div className="font-bold text-indigo-700 dark:text-indigo-300">{bondType}</div>
                                        <div className="text-xs text-gray-500 dark:text-gray-400">{bondDesc}</div>
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-1">
                                {renderRow('原子序', 'number')}
                                {renderRow('原子量', 'atomicMass', 'u')}
                                {renderRow('密度', 'density', 'g/cm³')}
                                {renderRow('熔點', 'meltingPoint', '°C')}
                                {renderRow('沸點', 'boilingPoint', '°C')}
                                {renderRow('電負度', 'electronegativity')}
                                {renderRow('原子半徑', 'atomicRadius', 'pm')}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DetailModal = ({ element, onClose, currentTemp, isFavorite, toggleFavorite, lang }) => {
            if (!element) return null;
            const [activeTab, setActiveTab] = useState('overview'); // 'overview', 'properties', 'atom', 'isotopes'
            const headerColorClass = MODAL_HEADER_COLORS[element.category] || 'bg-gray-800';
            const currentState = calculateState(element, currentTemp);
            
            const tabs = [
                { id: 'overview', label: '概覽' },
                { id: 'properties', label: '物理性質' },
                { id: 'atom', label: '原子結構' },
                { id: 'isotopes', label: '同位素' }
            ];

            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white dark:bg-gray-900 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto flex flex-col" onClick={e => e.stopPropagation()}>
                        
                        {/* Header */}
                        <div className={`p-6 flex justify-between items-start text-white ${headerColorClass}`}>
                            <div>
                                <div className="flex items-baseline gap-4">
                                    <span className="text-6xl font-bold font-mono tracking-tighter">{element.symbol}</span>
                                    <span className="text-4xl font-bold">{lang === 'zh' ? element.nameZh : element.nameEn}</span>
                                    <button onClick={() => toggleFavorite(element.number)} className="p-2 hover:bg-white/20 rounded-full transition-colors">
                                        <Icons.Star size={24} fill={isFavorite ? "currentColor" : "none"} className={isFavorite ? "text-yellow-400" : "text-white/50"} />
                                    </button>
                                </div>
                                <div className="text-xl opacity-90 font-medium mt-1">{lang === 'zh' ? element.nameEn : element.nameZh}</div>
                                <div className="mt-3 flex gap-2 flex-wrap">
                                    <span className="px-2 py-1 rounded text-sm font-mono border border-white/30 bg-white/20">NO. {element.number}</span>
                                    <span className="px-2 py-1 rounded text-sm uppercase tracking-wide border border-white/30 bg-white/20">{element.category}</span>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-white/20 rounded-full transition-colors"><Icons.X size={28} /></button>
                        </div>

                        {/* Tabs Navigation */}
                        <div className="flex border-b dark:border-gray-700 px-6 bg-gray-50 dark:bg-gray-800">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`py-3 px-4 text-sm font-bold border-b-2 transition-colors ${activeTab === tab.id ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200'}`}
                                >
                                    {tab.label}
                                </button>
                            ))}
                        </div>

                        {/* Tab Content */}
                        <div className="p-6 text-gray-800 dark:text-gray-200 min-h-[300px]">
                            
                            {activeTab === 'overview' && (
                                <div className="space-y-6 animate-in fade-in zoom-in duration-300">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                            <div className="text-xs text-gray-500 mb-1">原子量</div>
                                            <div className="text-xl font-mono font-bold">{element.atomicMass} u</div>
                                        </div>
                                        <div className="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                                            <div className="text-xs text-gray-500 mb-1">電子組態</div>
                                            <div className="text-sm font-mono font-bold">{element.config}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 className="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2"><Icons.Flask size={16}/> 常見化合物</h4>
                                        <div className="flex flex-wrap gap-2">
                                            {element.compounds.length > 0 ? element.compounds.map(c => <span key={c} className="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-3 py-1 rounded-full text-sm font-mono">{c}</span>) : <span className="text-gray-400 text-sm">無常見數據</span>}
                                        </div>
                                    </div>
                                    <div className="pt-4 border-t dark:border-gray-700">
                                        <a href={`https://zh.wikipedia.org/wiki/${element.nameZh}`} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-2 w-full py-3 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg transition-colors font-bold text-sm">
                                            <Icons.ExternalLink size={16}/> 前往維基百科
                                        </a>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'properties' && (
                                <div className="grid grid-cols-2 gap-y-4 text-sm animate-in fade-in zoom-in duration-300">
                                    <div className="text-gray-500 dark:text-gray-400">密度 (STP)</div><div className="font-mono font-medium">{element.density ? `${element.density} g/cm³` : 'N/A'}</div>
                                    <div className="text-gray-500 dark:text-gray-400">熔點</div><div className="font-mono font-medium">{element.meltingPoint ? `${element.meltingPoint} °C` : 'N/A'}</div>
                                    <div className="text-gray-500 dark:text-gray-400">沸點</div><div className="font-mono font-medium">{element.boilingPoint ? `${element.boilingPoint} °C` : 'N/A'}</div>
                                    <div className="text-gray-500 dark:text-gray-400">當前狀態</div>
                                    <div className="capitalize font-bold text-indigo-600 dark:text-indigo-400 flex items-center gap-2">
                                        {currentState === 'solid' && <><Icons.Square size={14} className="fill-current"/> 固體</>}
                                        {currentState === 'liquid' && <><Icons.Droplets size={14} /> 液體</>}
                                        {currentState === 'gas' && <><Icons.Circle size={14} /> 氣體</>}
                                    </div>
                                    <div className="text-gray-500 dark:text-gray-400">電負度</div><div className="font-mono font-medium">{element.electronegativity || 'N/A'}</div>
                                    <div className="text-gray-500 dark:text-gray-400">原子半徑</div><div className="font-mono font-medium">{element.atomicRadius} pm</div>
                                </div>
                            )}

                            {activeTab === 'atom' && (
                                <div className="space-y-4 animate-in fade-in zoom-in duration-300">
                                    <div className="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 flex flex-col items-center">
                                        <div className="text-xs text-gray-400 mb-2">波爾模型 (Bohr Model)</div>
                                        <AtomVisualizer shells={element.shells} />
                                        <div className="mt-2 font-mono text-sm text-gray-500">{element.shells.join(' - ')}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1">價電子軌域箱線圖</div>
                                        <OrbitalBoxDiagram shells={element.shells} />
                                    </div>
                                    <div className="flex justify-between text-sm border-t dark:border-gray-700 pt-3 mt-2">
                                        <span className="text-gray-500">晶體結構</span>
                                        <span className="font-bold font-mono">{element.structure?.toUpperCase()}</span>
                                    </div>
                                    <div className="h-24 flex justify-center items-center bg-gray-50 dark:bg-gray-800 rounded-lg overflow-hidden">
                                         <CrystalVisualizer structure={element.structure} />
                                    </div>
                                </div>
                            )}

                            {activeTab === 'isotopes' && (
                                <div className="animate-in fade-in zoom-in duration-300">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-gray-500 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-400">
                                            <tr>
                                                <th className="px-4 py-2">同位素</th>
                                                <th className="px-4 py-2">原子量 (u)</th>
                                                <th className="px-4 py-2">豐度</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {element.isotopes.map((iso, i) => (
                                                <tr key={i} className="border-b dark:border-gray-700">
                                                    <td className="px-4 py-2 font-bold">{element.symbol}-{iso.mass}</td>
                                                    <td className="px-4 py-2 font-mono">{iso.mass}.0xxx</td>
                                                    <td className="px-4 py-2">{iso.abundance}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <p className="text-xs text-gray-400 mt-4 text-center">* 同位素數據為模擬示範數據</p>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const PeriodicTableApp = () => {
            // States
            const [activeLayers, setActiveLayers] = useState({ ATOMIC_NUMBER: true, ATOMIC_MASS: true, EN_TEXT: false, STATE_ICON: true });
            const [heatmapMode, setHeatmapMode] = useState('NONE');
            const [selectedElement, setSelectedElement] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentTemp, setCurrentTemp] = useState(298.15);
            const [highlightCategory, setHighlightCategory] = useState(null);
            const [calcMode, setCalcMode] = useState(false);
            const [compound, setCompound] = useState([]);
            const [viewMode, setViewMode] = useState('GRID');
            const [lang, setLang] = useState('zh'); 
            const [favorites, setFavorites] = useState([]);
            const [simpleMode, setSimpleMode] = useState(false);
            const [filterState, setFilterState] = useState('all'); 
            const [quickJump, setQuickJump] = useState('');
            const [useBanding, setUseBanding] = useState(false); 
            const [compareMode, setCompareMode] = useState(false);
            const [compareList, setCompareList] = useState([]);
            const [darkMode, setDarkMode] = useState(false);
            const [rangeFilters, setRangeFilters] = useState({ mass: { min: 0, max: 300, enabled: false }, melting: { min: -273, max: 4000, enabled: false } });
            const [scatterConfig, setScatterConfig] = useState({ x: 'number', y: 'atomicRadius', enabled: false });
            const [customDataMode, setCustomDataMode] = useState('electronegativity');

            useEffect(() => {
                const saved = localStorage.getItem('pt_favorites');
                if (saved) setFavorites(JSON.parse(saved));
                const handleResize = () => { if (window.innerWidth >= 1024) setSidebarOpen(true); else setSidebarOpen(false); };
                window.addEventListener('resize', handleResize);
                handleResize();
                
                // Keyboard Shortcuts
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        setSelectedElement(null);
                        setCompareList([]);
                        setSidebarOpen(false);
                    }
                    if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                        e.preventDefault();
                        document.getElementById('main-search').focus();
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => {
                    window.removeEventListener('resize', handleResize);
                    window.removeEventListener('keydown', handleKeyDown);
                };
            }, []);

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [darkMode]);

            const toggleFavorite = (num) => {
                const newFavs = favorites.includes(num) ? favorites.filter(n => n !== num) : [...favorites, num];
                setFavorites(newFavs);
                localStorage.setItem('pt_favorites', JSON.stringify(newFavs));
            };

            const toggleLayer = (key) => setActiveLayers(p => ({ ...p, [key]: !p[key] }));
            const handleCalcAdd = (element) => setCompound(prev => [...prev, element]);
            const handleAddToCompare = (element) => {
                setCompareList(prev => {
                    if (prev.find(e => e.number === element.number)) return prev.filter(e => e.number !== element.number);
                    if (prev.length >= 2) return [prev[1], element]; 
                    return [...prev, element];
                });
            };
            const handleQuickJump = (e) => {
                e.preventDefault();
                const num = parseInt(quickJump);
                const target = elementsData.find(el => el.number === num);
                if (target) { setSelectedElement(target); setQuickJump(''); }
            };

            const downloadCSV = () => {
                const headers = ["AtomicNumber", "Symbol", "Name", "Mass", "Density", "Melting", "Boiling", "Electronegativity"];
                const rows = elementsData.map(e => [e.number, e.symbol, e.nameEn, e.atomicMass, e.density, e.meltingPoint, e.boilingPoint, e.electronegativity]);
                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "periodic_table_data.csv");
                document.body.appendChild(link);
                link.click();
            };

            const filteredElements = elementsData.filter(e => {
                const matchesSearch = e.nameZh.includes(searchTerm) || e.symbol.toLowerCase().includes(searchTerm.toLowerCase()) || e.nameEn.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesFav = highlightCategory === 'fav' ? favorites.includes(e.number) : true;
                let matchesRange = true;
                if (rangeFilters.mass.enabled && (e.atomicMass < rangeFilters.mass.min || e.atomicMass > rangeFilters.mass.max)) matchesRange = false;
                if (rangeFilters.melting.enabled && (e.meltingPoint < rangeFilters.melting.min || e.meltingPoint > rangeFilters.melting.max)) matchesRange = false;
                return matchesSearch && matchesFav && matchesRange;
            });

            return (
                <div className="min-h-screen flex flex-col h-screen overflow-hidden">
                    <header className="bg-white dark:bg-dark-card border-b dark:border-gray-700 px-4 py-2 flex items-center justify-between shadow-sm z-30 shrink-0 h-16 transition-colors">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} className="lg:hidden p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><Icons.Menu size={24} /></button>
                            <div className="flex items-center gap-2">
                                <div className="bg-indigo-600 text-white p-1.5 rounded hidden sm:block"><Icons.Layers size={20} /></div>
                                <h1 className="text-lg sm:text-xl font-bold tracking-tight text-indigo-900 dark:text-indigo-300">元素週期表 <span className="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-700 dark:text-indigo-300 px-2 py-0.5 rounded-full align-middle ml-1">v2.1.0</span></h1>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <form onSubmit={handleQuickJump} className="hidden md:flex items-center relative">
                                <span className="absolute left-3 text-xs font-bold text-gray-400">#</span>
                                <input type="number" placeholder="跳轉" value={quickJump} onChange={e => setQuickJump(e.target.value)} className="w-20 pl-6 pr-2 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 border-none outline-none" />
                            </form>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-yellow-400">
                                {darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}
                            </button>
                            {calcMode ? (
                                <div className="hidden sm:flex items-center gap-2 text-sm font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/50 px-3 py-1 rounded-full border border-indigo-100 dark:border-indigo-800 animate-pulse"><Icons.Calculator size={16}/> 計算中</div>
                            ) : compareMode ? (
                                <div className="hidden sm:flex items-center gap-2 text-sm font-bold text-pink-600 dark:text-pink-400 bg-pink-50 dark:bg-pink-900/50 px-3 py-1 rounded-full border border-pink-100 dark:border-pink-800 animate-pulse"><Icons.Split size={16}/> 對比中</div>
                            ) : (
                                <div className="relative hidden sm:block">
                                    <Icons.Search size={16} className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                                    <input id="main-search" type="text" placeholder="搜尋 (按 /)" className="pl-9 pr-4 py-1.5 bg-gray-100 dark:bg-gray-700 dark:text-white border-transparent focus:bg-white dark:focus:bg-gray-600 focus:border-indigo-300 rounded-full text-sm w-40 transition-all outline-none" value={searchTerm} onChange={e => setSearchTerm(e.target.value)}/>
                                </div>
                            )}
                        </div>
                    </header>

                    <div className="flex flex-1 overflow-hidden relative">
                        {sidebarOpen && <div className="fixed inset-0 bg-black/50 z-20 lg:hidden glass" onClick={() => setSidebarOpen(false)} />}
                        
                        <aside className={`fixed lg:static inset-y-0 left-0 w-80 bg-white dark:bg-dark-card border-r dark:border-gray-700 shadow-xl lg:shadow-none z-40 transform transition-transform duration-300 ease-in-out flex flex-col ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:translate-x-0`}>
                            <div className="lg:hidden p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800">
                                <span className="font-bold text-gray-700 dark:text-gray-200">控制面板</span>
                                <button onClick={() => setSidebarOpen(false)} className="p-1 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full dark:text-white"><Icons.X size={20} /></button>
                            </div>

                            <div className="p-4 space-y-6 overflow-y-auto flex-1 custom-scrollbar">
                                {/* Tools */}
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')} className="flex items-center justify-center gap-2 p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-200 transition">
                                        <Icons.Languages size={16}/> {lang === 'zh' ? 'EN' : '中文'}
                                    </button>
                                    <button onClick={downloadCSV} className="flex items-center justify-center gap-2 p-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-200 transition">
                                        <Icons.Download size={16}/> 導出數據
                                    </button>
                                </div>

                                {/* Advanced Filters (New) */}
                                <div className="border dark:border-gray-700 rounded-lg p-3">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-2 flex items-center gap-2"><Icons.Filter size={12}/> 進階篩選</h3>
                                    
                                    <div className="mb-2">
                                        <div className="flex justify-between text-xs mb-1 text-gray-600 dark:text-gray-400">
                                            <span>熔點範圍</span>
                                            <input type="checkbox" checked={rangeFilters.melting.enabled} onChange={e => setRangeFilters({...rangeFilters, melting: {...rangeFilters.melting, enabled: e.target.checked}})} className="accent-indigo-500"/>
                                        </div>
                                        {rangeFilters.melting.enabled && (
                                            <div className="flex gap-1">
                                                <input type="number" value={rangeFilters.melting.min} onChange={e => setRangeFilters({...rangeFilters, melting: {...rangeFilters.melting, min: Number(e.target.value)}})} className="w-16 p-1 text-xs border rounded dark:bg-gray-700 dark:text-white" />
                                                <span className="text-gray-400">-</span>
                                                <input type="number" value={rangeFilters.melting.max} onChange={e => setRangeFilters({...rangeFilters, melting: {...rangeFilters.melting, max: Number(e.target.value)}})} className="w-16 p-1 text-xs border rounded dark:bg-gray-700 dark:text-white" />
                                            </div>
                                        )}
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-xs mb-1 text-gray-600 dark:text-gray-400">
                                            <span>原子量範圍</span>
                                            <input type="checkbox" checked={rangeFilters.mass.enabled} onChange={e => setRangeFilters({...rangeFilters, mass: {...rangeFilters.mass, enabled: e.target.checked}})} className="accent-indigo-500"/>
                                        </div>
                                        {rangeFilters.mass.enabled && (
                                            <div className="flex gap-1">
                                                <input type="number" value={rangeFilters.mass.min} onChange={e => setRangeFilters({...rangeFilters, mass: {...rangeFilters.mass, min: Number(e.target.value)}})} className="w-16 p-1 text-xs border rounded dark:bg-gray-700 dark:text-white" />
                                                <span className="text-gray-400">-</span>
                                                <input type="number" value={rangeFilters.mass.max} onChange={e => setRangeFilters({...rangeFilters, mass: {...rangeFilters.mass, max: Number(e.target.value)}})} className="w-16 p-1 text-xs border rounded dark:bg-gray-700 dark:text-white" />
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Custom Data Display Toggle */}
                                <div>
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-2">方塊顯示數據</h3>
                                    <select value={customDataMode} onChange={e => setCustomDataMode(e.target.value)} className="w-full text-xs p-2 rounded border dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                        <option value="electronegativity">電負度 (Electronegativity)</option>
                                        <option value="mass">原子量 (Atomic Mass)</option>
                                        <option value="radius">原子半徑 (Radius)</option>
                                        <option value="shells">電子層數 (Shells)</option>
                                    </select>
                                </div>

                                {/* View Switcher */}
                                <div className="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                                    {['GRID', 'LIST', 'GRAPH'].map(m => (
                                        <button key={m} onClick={() => setViewMode(m)} className={`flex-1 py-1.5 rounded-md text-xs font-bold transition-all ${viewMode === m ? 'bg-white dark:bg-gray-600 text-indigo-600 dark:text-indigo-300 shadow-sm' : 'text-gray-500 dark:text-gray-400'}`}>
                                            {m === 'GRID' ? '週期表' : m === 'LIST' ? '清單' : '圖表'}
                                        </button>
                                    ))}
                                </div>

                                {/* Heatmap */}
                                <div>
                                    <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 flex items-center gap-2"><Icons.Activity size={14} /> 數據熱圖</h3>
                                    {heatmapMode !== 'NONE' && (
                                        <div className="flex items-center justify-between mb-2 bg-gray-50 dark:bg-gray-800 p-2 rounded border dark:border-gray-600">
                                            <span className="text-xs text-gray-600 dark:text-gray-400 font-bold">模式</span>
                                            <div className="flex bg-white dark:bg-gray-700 rounded border dark:border-gray-600 overflow-hidden">
                                                <button onClick={() => setUseBanding(false)} className={`px-2 py-1 text-[10px] ${!useBanding ? 'bg-indigo-600 text-white' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'}`}>連續</button>
                                                <button onClick={() => setUseBanding(true)} className={`px-2 py-1 text-[10px] ${useBanding ? 'bg-indigo-600 text-white' : 'text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'}`}>分層</button>
                                            </div>
                                        </div>
                                    )}
                                    <div className="space-y-1">
                                        {Object.keys(HEATMAP_MODES).map(key => (
                                            <button key={key} onClick={() => { setHeatmapMode(key); setHighlightCategory(null); }} className={`w-full text-left px-3 py-2 rounded-lg text-sm transition-all flex items-center justify-between border dark:border-gray-700 ${heatmapMode === key ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 font-bold border-indigo-200 dark:border-indigo-800 shadow-sm' : 'text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-800 border-transparent'}`}>
                                                {HEATMAP_MODES[key].label}
                                                {heatmapMode === key && <div className="w-2 h-2 rounded-full bg-indigo-500 shadow-sm"></div>}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Calc & Compare Toggles */}
                                <div className="grid grid-cols-2 gap-2">
                                    <div className={`p-3 rounded-xl border dark:border-gray-700 cursor-pointer transition flex flex-col items-center justify-center text-center gap-1 ${calcMode ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-800 dark:text-gray-300 hover:border-indigo-300'}`} onClick={() => { setCalcMode(!calcMode); if(!calcMode) {setCompareMode(false); setSidebarOpen(false);} }}>
                                        <Icons.Calculator size={18} /> <span className="text-xs font-bold">質量計算</span>
                                    </div>
                                    <div className={`p-3 rounded-xl border dark:border-gray-700 cursor-pointer transition flex flex-col items-center justify-center text-center gap-1 ${compareMode ? 'bg-pink-600 text-white' : 'bg-white dark:bg-gray-800 dark:text-gray-300 hover:border-pink-300'}`} onClick={() => { setCompareMode(!compareMode); if(!compareMode) {setCalcMode(false); setSidebarOpen(false);} }}>
                                        <Icons.Split size={18} /> <span className="text-xs font-bold">元素對比</span>
                                    </div>
                                </div>
                            </div>
                        </aside>

                        <main className="flex-1 overflow-auto bg-slate-100 dark:bg-gray-900 p-2 sm:p-4 md:p-6 relative transition-colors">
                            {calcMode && (
                                <div className="sticky top-0 z-20 mb-4 max-w-fit mx-auto">
                                    <CalculatorPanel compound={compound} onClear={() => setCompound([])} onRemoveLast={() => setCompound(p => p.slice(0, -1))}/>
                                </div>
                            )}
                            
                            {/* Compare Panel is simpler, usually just a modal logic, but we can add a sticky indicator */}
                            {compareMode && compareList.length > 0 && (
                                <div className="sticky top-0 z-20 mb-4 max-w-fit mx-auto bg-pink-900 text-white p-2 rounded-lg shadow-lg flex gap-4 items-center animate-in slide-in-from-top-2">
                                    <span className="text-sm font-bold">對比清單 ({compareList.length}/2)</span>
                                    {compareList.length === 2 && <button onClick={()=>{/*Logic handled in modal*/}} className="bg-white text-pink-900 px-2 py-1 rounded text-xs font-bold animate-pulse">查看對比</button>}
                                    <button onClick={() => setCompareList([])}><Icons.Trash2 size={16}/></button>
                                </div>
                            )}

                            {viewMode === 'GRID' && (
                                <div className="min-w-fit mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-2 sm:p-6 overflow-x-auto transition-colors">
                                    <div className="grid gap-1 min-w-[800px] select-none" style={{ gridTemplateColumns: 'repeat(18, minmax(36px, 1fr))', gridTemplateRows: 'repeat(9, minmax(36px, 1fr))' }}>
                                        {[...Array(18)].map((_, i) => <div key={`g-${i}`} className="text-center text-[10px] text-gray-300 dark:text-gray-600 font-mono row-start-1" style={{ gridColumn: i + 1 }}>{i+1}</div>)}
                                        {filteredElements.map(element => (
                                            <ElementCell key={element.number} element={element} activeLayers={activeLayers} heatmapMode={heatmapMode} onSelect={setSelectedElement} currentTemp={currentTemp} highlightCategory={highlightCategory} calcMode={calcMode} onCalcAdd={handleCalcAdd} lang={lang} isFavorite={favorites.includes(element.number)} simpleMode={simpleMode} filterState={filterState} useBanding={useBanding} compareMode={compareMode} onAddToCompare={handleAddToCompare} isSelectedForCompare={compareList.find(e=>e.number===element.number)} customDataMode={customDataMode} />
                                        ))}
                                        <div className="col-start-3 row-start-6 flex items-center justify-center text-xs text-gray-400 dark:text-gray-600 border border-dashed border-gray-300 dark:border-gray-600 rounded pointer-events-none">57-71</div>
                                        <div className="col-start-3 row-start-7 flex items-center justify-center text-xs text-gray-400 dark:text-gray-600 border border-dashed border-gray-300 dark:border-gray-600 rounded pointer-events-none">89-103</div>
                                        <div className="col-start-1 row-start-8 col-span-2 flex items-center justify-end pr-2 text-xs font-bold text-gray-400 dark:text-gray-600">Lanthanides</div>
                                        <div className="col-start-1 row-start-9 col-span-2 flex items-center justify-end pr-2 text-xs font-bold text-gray-400 dark:text-gray-600">Actinides</div>
                                    </div>
                                </div>
                            )}

                            {viewMode === 'LIST' && <ListView elements={filteredElements} onSelect={setSelectedElement} lang={lang} onSort={()=>{}} />}
                            {viewMode === 'GRAPH' && <GraphView elements={filteredElements} heatmapMode={heatmapMode} scatterConfig={scatterConfig} setScatterConfig={setScatterConfig} />}
                        </main>
                    </div>

                    {selectedElement && !calcMode && !compareMode && <DetailModal element={selectedElement} onClose={() => setSelectedElement(null)} currentTemp={currentTemp} isFavorite={favorites.includes(selectedElement.number)} toggleFavorite={toggleFavorite} lang={lang} />}
                    {compareList.length === 2 && compareMode && <ComparisonModal items={compareList} onClose={() => setCompareList([])} lang={lang} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PeriodicTableApp />);
    </script>
</body>
</html>
